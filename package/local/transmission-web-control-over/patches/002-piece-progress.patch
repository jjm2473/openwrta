From 06abbbd0f0ed2d7cd4b20e2dffb353444f12f2c8 Mon Sep 17 00:00:00 2001
From: Liangbin Lian <jjm2473@gmail.com>
Date: Fri, 28 Aug 2020 23:45:54 +0800
Subject: [PATCH] show piece download progress

(cherry picked from commit 30cdec42478435b12ecc439b7d86094b740ae4f2)
---
 src/index.html                                |   4 +-
 src/tr-web-control/script/jquery/Base64.js    |  11 +-
 src/tr-web-control/script/min/system.min.js   | 115 +-----------------
 src/tr-web-control/script/system.js           |  31 ++++-
 src/tr-web-control/style/base.css             |  15 ++-
 .../template/torrent-attribute.html           |   9 ++
 6 files changed, 63 insertions(+), 122 deletions(-)

diff --git a/src/index.html b/src/index.html
index 5236666..1f20efd 100644
--- a/src/index.html
+++ b/src/index.html
@@ -11,7 +11,7 @@
 	<link rel="stylesheet" type="text/css" href="tr-web-control/style/before-easyui.css?v=20190724" />
 	<link id="styleEasyui" rel="stylesheet" type="text/css" href="tr-web-control/script/easyui/themes/default/easyui.css?v=20190724"/>
 	<link rel="stylesheet" type="text/css" href="tr-web-control/script/plugins/jquery.webui-popover.css" />
-	<link rel="stylesheet" type="text/css" href="tr-web-control/style/base.css?v=20190724" />
+	<link rel="stylesheet" type="text/css" href="tr-web-control/style/base.css?v=20200828" />
 	<link rel="stylesheet" type="text/css" href="tr-web-control/script/easyui/themes/icon.css?v=20190724"/>
 	<link rel="stylesheet" type="text/css" href="tr-web-control/style/icon.custom.css?v=20190724"/>
 	<link rel="stylesheet" type="text/css" href="tr-web-control/style/iconfont/iconfont.css?v=20190724"/>
@@ -33,7 +33,7 @@
 	<script type="text/javascript" src="tr-web-control/script/other/ua-parser.min.js?v=20190724"></script>
 	<script type="text/javascript" src="tr-web-control/script/min/transmission.min.js?v=20190724"></script>
 	<script type="text/javascript" src="tr-web-control/script/min/transmission.torrents.min.js?v=20171027"></script>
-	<script type="text/javascript" src="tr-web-control/script/min/system.min.js?v=20190724"></script>
+	<script type="text/javascript" src="tr-web-control/script/min/system.min.js?v=20200828"></script>
 	<script type="text/javascript" src="tr-web-control/config.js?v=20190724"></script>
 	<script type="text/javascript" src="tr-web-control/plugin.js?v=20190724"></script>
 	<script type="text/javascript">
diff --git a/src/tr-web-control/script/jquery/Base64.js b/src/tr-web-control/script/jquery/Base64.js
index f0cf85f..1180a2b 100644
--- a/src/tr-web-control/script/jquery/Base64.js
+++ b/src/tr-web-control/script/jquery/Base64.js
@@ -40,7 +40,7 @@ function Base64() {
 	}
  
 	// public method for decoding
-	this.decode = function (input) {
+	var decode_bytes = this.decode_bytes = function (input) {
 		var output = "";
 		var chr1, chr2, chr3;
 		var enc1, enc2, enc3, enc4;
@@ -62,12 +62,15 @@ function Base64() {
 				output = output + String.fromCharCode(chr3);
 			}
 		}
-		output = _utf8_decode(output);
 		return output;
 	}
+
+	this.decode = function (input) {
+		return _utf8_decode(decode_bytes(input));
+	}
  
 	// private method for UTF-8 encoding
-	_utf8_encode = function (string) {
+	var _utf8_encode = function (string) {
 		string = string.replace(/\r\n/g,"\n");
 		var utftext = "";
 		for (var n = 0; n < string.length; n++) {
@@ -88,7 +91,7 @@ function Base64() {
 	}
  
 	// private method for UTF-8 decoding
-	_utf8_decode = function (utftext) {
+	var _utf8_decode = function (utftext) {
 		var string = "";
 		var i = 0;
 		var c = c1 = c2 = 0;
diff --git a/src/tr-web-control/script/min/system.min.js b/src/tr-web-control/script/min/system.min.js
index 94b0a30..375b83e 100644
--- a/src/tr-web-control/script/min/system.min.js
+++ b/src/tr-web-control/script/min/system.min.js
@@ -1,114 +1 @@
-var system={version:"1.6.0",rootPath:"tr-web-control/",codeupdate:"20190724",configHead:"transmission-web-control",config:{autoReload:true,reloadStep:5E3,pageSize:30,pagination:true,pageList:[10,20,30,40,50,100,150,200,250,300],defaultSelectNode:null,autoExpandAttribute:false,defaultLang:"",foldersShow:false,theme:"default",showBTServers:false,ui:{status:{tree:{},layout:{main:{},body:{},left:{}},panel:{},size:{nav:{},attribute:{}}}},hideSubfolders:false,simpleCheckMode:false,nav:{servers:true,folders:true,
-statistics:true,labels:false},labels:[],labelMaps:{},ignoreVersion:[]},storageKeys:{dictionary:{folders:"dictionary.folders"}},dictionary:{folders:null},checkUpdateScript:"https://api.github.com/repos/ronggang/transmission-web-control/releases/latest",contextMenus:{},panel:null,lang:null,reloading:false,autoReloadTimer:null,downloadDir:"",islocal:false,B64:new Base64,currentTorrentId:0,control:{tree:null,torrentlist:null},userConfig:{torrentList:{fields:[],sortName:null,sortOrder:"asc"}},serverConfig:null,
-serverSessionStats:null,templates:{},checkedRows:[],uiIsInitialized:false,popoverCount:0,setlang:function(a,b){a||(a=this.config.defaultLang?this.config.defaultLang:navigator.language||navigator.browserLanguage);a||(a="zh-CN");if(a.indexOf("-")!=-1)a=a.split("-")[0].toLocaleLowerCase()+"-"+a.split("-")[1].toLocaleUpperCase();this.languages[a]||(a="en");a=a.replace("-","_");$.getJSON(system.rootPath+"i18n/"+a+".json",function(c){if(c)system.lang=$.extend(true,system.defaultLang,c);system.resetLangText();
-$.getScript(system.rootPath+"script/easyui/locale/easyui-lang-"+a+".js").done(function(){b&&b()}).fail(function(){$.getScript(system.rootPath+"script/easyui/locale/easyui-lang-en.js",function(){b&&b()})})})},init:function(a,b){this.readConfig();this.lastUIStatus=JSON.parse(JSON.stringify(this.config.ui.status));this.islocal=b==1?true:false;this.panel={main:$("#main"),top:$("#m_top"),toolbar:$("#m_toolbar"),left_layout:$("#m_left_layout"),left:$("#m_left"),body:$("#m_body"),layout_body:$("#layout_body"),
-layout_left:$("#layout_left"),list:$("#m_list"),attribute:$("#m_attribute"),bottom:$("#m_bottom"),title:$("#m_title"),status:$("#m_status"),statusbar:$("#m_statusbar"),status_text:$("#status_text"),droparea:$("#dropArea")};this.lang==null?this.setlang(a,function(){system.initdata()}):this.initdata();this.initThemes();this.clipboard=new ClipboardJS("#toolbar_copyPath")},resetLangText:function(a){a||(a=$);var b=a.find("*[system-lang]");$.each(b,function(c,d){var e=$(d).attr("system-lang");e.substr(0,
-1)=="["?$(d).html(eval("system.lang"+e)):$(d).html(eval("system.lang."+e))});b=a.find("*[system-tip-lang]");$.each(b,function(c,d){var e=$(d).attr("system-tip-lang");e.substr(0,1)=="["?$(d).attr("title",eval("system.lang"+e)):$(d).attr("title",eval("system.lang."+e))})},initdata:function(){$(document).attr("title",this.lang.system.title+" "+this.version);$.fn.switchbutton.defaults.onText=this.lang["public"]["text-on"];$.fn.switchbutton.defaults.offText=this.lang["public"]["text-off"];var a=[],b="<span>"+
-this.lang.title.left+"</span>";if(a.length>1){b+=a.join("");this.panel.left_layout.panel("setTitle",b);for(var c in this.lang.tree.toolbar.nav){$("#tree-toolbar-nav-"+c).linkbutton();switch(c){case "folders":system.config.foldersShow?$("tree-toolbar-nav-"+c).linkbutton({iconCls:"icon-enabled"}).data("status",1):$("tree-toolbar-nav-"+c).linkbutton({iconCls:"icon-disabled"}).data("status",0)}}}else this.panel.left_layout.panel("setTitle",b);b="<span>"+this.lang.title.list+"</span>";a.length=0;if(a.length>
-1){b+=a.join("");this.panel.body.panel("setTitle",b);for(c in this.lang["torrent-head"].buttons){$("#torrent-head-buttons-"+c).linkbutton();switch(c){case "autoExpandAttribute":system.config.autoExpandAttribute?$("#torrent-head-buttons-"+c).linkbutton({iconCls:"icon-enabled"}).data("status",1):$("#torrent-head-buttons-"+c).linkbutton({iconCls:"icon-disabled"}).data("status",0)}}}else this.panel.body.panel("setTitle",b);this.panel.status.panel("setTitle",this.lang.title.status);this.panel.attribute.panel({title:this.lang.title.attribute,
-onExpand:function(){system.currentTorrentId!=0&&$(this).data("isload")?system.getTorrentInfos(system.currentTorrentId):system.clearTorrentAttribute()},onLoad:function(){if(!$(this).data("isload")){$(this).data("isload",true);system.currentTorrentId!=0&&setTimeout(function(){system.getTorrentInfos(system.currentTorrentId)},500)}}});$.each(this.languages,function(d,e){$("<option/>").text(e).val(d).attr("selected",d==system.lang.name?true:false).appendTo(system.panel.top.find("#lang"))});this.panel.top.find("#lang").change(function(){location.href=
-"?lang="+this.value});this.panel.toolbar.attr("class","panel-header");this.initTree();this.initToolbar();this.initStatusBar();this.initTorrentTable();this.connect();this.initEvent();this.checkUpdate()},initEvent:function(){$(window).resize(function(){$("#main").layout("resize")});this.panel.droparea[0].addEventListener("dragover",function(a){a.stopPropagation();a.preventDefault();system.debug("#dropArea.dragover")},false);this.panel.list[0].addEventListener("dragover",function(a){a.stopPropagation();
-a.preventDefault();system.panel.droparea.show();system.debug("dragover")},false);this.panel.droparea[0].addEventListener("drop",function(a){a.stopPropagation();a.preventDefault();system.panel.droparea.hide();system.debug("drop.e.dataTransfer:",a.dataTransfer);system.checkDropFiles(a.dataTransfer.files)},false);this.panel.droparea[0].addEventListener("dragleave",function(a){a.stopPropagation();a.preventDefault();system.panel.droparea.hide();system.debug("dragleave")},false);$("#text-drop-title").html(this.lang["public"]["text-drop-title"]);
-$("#button-cancel-checked").on("click",function(){system.control.torrentlist.datagrid("uncheckAll")});this.panel.left.tree({onExpand:function(a){system.config.ui.status.tree[a.id]=a.state;system.saveConfig()},onCollapse:function(a){system.config.ui.status.tree[a.id]=a.state;system.saveConfig()}});this.panel.layout_body.layout({onExpand:function(a){system.config.ui.status.layout.body[a]="open";system.saveConfig()},onCollapse:function(a){system.config.ui.status.layout.body[a]="closed";system.saveConfig()}});
-this.panel.layout_left.layout({onExpand:function(a){system.config.ui.status.layout.left[a]="open";system.saveConfig()},onCollapse:function(a){system.config.ui.status.layout.left[a]="closed";system.saveConfig()}});this.panel.main.layout({onExpand:function(a){system.config.ui.status.layout.main[a]="open";system.saveConfig()},onCollapse:function(a){system.config.ui.status.layout.main[a]="closed";system.saveConfig()}})},layoutResize:function(a,b){if(system.uiIsInitialized)if(system.config.ui.status.size[a]){system.config.ui.status.size[a]=
-b;system.saveConfig()}},navToolbarClick:function(a){var b=a.id,c=$(a).data("status"),d=null;switch(b){case "tree-toolbar-nav-folders":d=this.panel.left.tree("find","folders");this.config.foldersShow=c==1?false:true;break;case "tree-toolbar-nav-statistics":d=this.panel.left.tree("find","statistics");break;case "torrent-head-buttons-autoExpandAttribute":d={};d.target=null;this.config.autoExpandAttribute=c==1?false:true}if(d){if(c==1){$(a).linkbutton({iconCls:"icon-disabled"});$(d.target).parent().hide();
-c=0}else{$(a).linkbutton({iconCls:"icon-enabled"});$(d.target).parent().show();c=1}$(a).data("status",c);this.saveConfig()}},checkDropFiles:function(a){if(a&&a.length){for(var b=[],c=0;c<a.length;c++){var d=a[c];d.name.split(".").pop().toLowerCase()=="torrent"&&b.push(d)}if(b.length>0)system.openDialogFromTemplate({id:"dialog-torrent-addfile",options:{title:system.lang.toolbar["add-torrent"],width:620,height:system.config.nav.labels?500:300,resizable:true},datas:{files:b}})}},initTree:function(){var a=
-[{id:"torrent-all",iconCls:"iconfont tr-icon-home",text:this.lang.tree.all+" ("+this.lang.tree.status.loading+")",children:[{id:"downloading",text:this.lang.tree.downloading,iconCls:"iconfont tr-icon-download"},{id:"paused",text:this.lang.tree.paused,iconCls:"iconfont tr-icon-pause2"},{id:"sending",text:this.lang.tree.sending,iconCls:"iconfont tr-icon-upload"},{id:"check",text:this.lang.tree.check,iconCls:"iconfont tr-icon-data-check"},{id:"actively",text:this.lang.tree.actively,iconCls:"iconfont tr-icon-actively"},
-{id:"error",text:this.lang.tree.error,iconCls:"iconfont tr-icon-errors"},{id:"warning",text:this.lang.tree.warning,iconCls:"iconfont tr-icon-warning"}]}],b={servers:{id:"servers",text:this.lang.tree.servers,state:"closed",iconCls:"iconfont tr-icon-servers",children:[{id:"servers-loading",text:this.lang.tree.status.loading,iconCls:"tree-loading"}]},folders:{id:"folders",text:this.lang.tree.folders,iconCls:"iconfont tr-icon-folder",state:"closed",children:[{id:"folders-loading",text:this.lang.tree.status.loading,
-iconCls:"tree-loading"}]},statistics:{id:"statistics",text:this.lang.tree.statistics.title,state:"closed",iconCls:"iconfont tr-icon-shuju",children:[{id:"cumulative-stats",text:this.lang.tree.statistics.cumulative,iconCls:"iconfont tr-icon-folder",children:[{id:"uploadedBytes",text:this.lang.tree.statistics.uploadedBytes,iconCls:"iconfont tr-icon-empty"},{id:"downloadedBytes",text:this.lang.tree.statistics.downloadedBytes,iconCls:"iconfont tr-icon-empty"},{id:"filesAdded",text:this.lang.tree.statistics.filesAdded,
-iconCls:"iconfont tr-icon-empty"},{id:"sessionCount",text:this.lang.tree.statistics.sessionCount,iconCls:"iconfont tr-icon-empty"},{id:"secondsActive",text:this.lang.tree.statistics.secondsActive,iconCls:"iconfont tr-icon-empty"}]},{id:"current-stats",text:this.lang.tree.statistics.current,iconCls:"iconfont tr-icon-folder",children:[{id:"current-uploadedBytes",text:this.lang.tree.statistics.uploadedBytes,iconCls:"iconfont tr-icon-empty"},{id:"current-downloadedBytes",text:this.lang.tree.statistics.downloadedBytes,
-iconCls:"iconfont tr-icon-empty"},{id:"current-filesAdded",text:this.lang.tree.statistics.filesAdded,iconCls:"iconfont tr-icon-empty"},{id:"current-sessionCount",text:this.lang.tree.statistics.sessionCount,iconCls:"iconfont tr-icon-empty"},{id:"current-secondsActive",text:this.lang.tree.statistics.secondsActive,iconCls:"iconfont tr-icon-empty"}]}]},labels:{id:"labels",text:this.lang.tree.labels,iconCls:"iconfont tr-icon-labels"}},c;for(c in this.config.nav){var d=this.config.nav[c],e=b[c];e&&d&&a.push(e)}this.panel.left.tree({data:a,
-onSelect:function(f){system.loadTorrentToList({node:f})},lines:true})},initUIStatus:function(){if(!this.uiIsInitialized){system.uiIsInitialized=true;var a=this.lastUIStatus.tree,b;for(b in a){var c=this.panel.left.tree("find",b);if(c&&c.target)a[b]=="open"?this.panel.left.tree("expand",c.target):this.panel.left.tree("collapse",c.target)}if(this.config.defaultSelectNode){(c=this.panel.left.tree("find",this.config.defaultSelectNode))&&(this.config.foldersShow||this.config.defaultSelectNode.indexOf("folders")==
--1)||(c=this.panel.left.tree("find","torrent-all"));this.panel.left.tree("select",c.target)}if(this.lastUIStatus.size.nav&&this.lastUIStatus.size.nav.width){this.panel.main.layout("panel","west").panel("resize",{width:this.lastUIStatus.size.nav.width+5});this.panel.main.layout("resize")}if(this.lastUIStatus.size.attribute&&this.lastUIStatus.size.attribute.height){this.panel.layout_body.layout("panel","south").panel("resize",{height:this.lastUIStatus.size.attribute.height});this.panel.layout_body.layout("resize")}a=
-this.lastUIStatus.layout.body;for(b in a)a[b]=="open"?this.panel.layout_body.layout("expand",b):this.panel.layout_body.layout("collapse",b);a=this.lastUIStatus.layout.left;for(b in a)a[b]=="open"?this.panel.layout_left.layout("expand",b):this.panel.layout_left.layout("collapse",b);a=this.lastUIStatus.layout.main;for(b in a)a[b]=="open"?this.panel.main.layout("expand",b):this.panel.main.layout("collapse",b)}},initTorrentTable:function(){function a(){b&&$(b).remove();b=$("<div/>").appendTo("body");
-b.menu({onClick:function(h){if(h.iconCls=="icon-ok"){system.control.torrentlist.datagrid("hideColumn",h.name);b.menu("setIcon",{target:h.target,iconCls:"icon-empty"})}else{system.control.torrentlist.datagrid("showColumn",h.name);b.menu("setIcon",{target:h.target,iconCls:"icon-ok"})}system.resetTorrentListFieldsUserConfig(system.control.torrentlist.datagrid("options").columns[0]);system.saveUserConfig()}});for(var d=system.control.torrentlist.datagrid("getColumnFields"),e=0;e<d.length;e++){var f=d[e],
-g=system.control.torrentlist.datagrid("getColumnOption",f);if(g.allowCustom!=false&&g.allowCustom!="false")b.menu("appendItem",{text:g.title,name:f,iconCls:g.hidden?"icon-empty":"icon-ok"})}}this.control.torrentlist=$("<table/>").attr("class","torrent-list").appendTo(this.panel.list);var b=null,c=-1;$.get(system.rootPath+"template/torrent-fields.json?time="+new Date,function(d){d=d.fields;for(var e={},f=0;f<d.length;f++){var g=d[f];e[g.field]=g}if(system.userConfig.torrentList.fields.length!=0)d=
-$.extend(d,system.userConfig.torrentList.fields);system.userConfig.torrentList.fields=d;for(var h in d){g=d[h];if((f=e[g.field])&&f.formatter)g.formatter=f.formatter;else g.formatter&&delete g.formatter;if(f&&f.sortable)g.sortable=f.sortable;else g.sortable&&delete g.sortable;g.title=system.lang.torrent.fields[g.field]||g.field;system.setFieldFormat(g)}system.control.torrentlist.datagrid({autoRowHeight:false,pagination:system.config.pagination,rownumbers:true,remoteSort:false,checkOnSelect:false,
-pageSize:system.config.pageSize,pageList:system.config.pageList,idField:"id",fit:true,striped:true,sortName:system.userConfig.torrentList.sortName,sortOrder:system.userConfig.torrentList.sortOrder,drophead:true,columns:[d],onCheck:function(i,j){system.checkTorrentRow(i,j)},onUncheck:function(i,j){system.checkTorrentRow(i,j)},onCheckAll:function(){system.checkTorrentRow("all",false)},onUncheckAll:function(){system.checkTorrentRow("all",true)},onSelect:function(i,j){c!=-1&&system.control.torrentlist.datagrid("unselectRow",
-c);system.getTorrentInfos(j.id);c=i},onUnselect:function(){system.currentTorrentId=0;c=-1},onBeforeLoad:function(){system.currentTorrentId=0},onSortColumn:function(i,j){var k=system.control.torrentlist.datagrid("getData").originalRows.sort(arrayObjectSort(i,j));system.control.torrentlist.datagrid("loadData",k);system.resetTorrentListFieldsUserConfig(system.control.torrentlist.datagrid("options").columns[0]);system.userConfig.torrentList.sortName=i;system.userConfig.torrentList.sortOrder=j;system.saveUserConfig()},
-onRowContextMenu:function(i,j){system.config.simpleCheckMode&&system.control.torrentlist.datagrid("uncheckAll");system.checkedRows.length==0&&system.control.torrentlist.datagrid("checkRow",j);i.preventDefault();system.showContextMenu("torrent-list",i)},onHeadDrop:function(){system.resetTorrentListFieldsUserConfig(system.control.torrentlist.datagrid("options").columns[0]);system.saveUserConfig()},onResizeColumn:function(){system.resetTorrentListFieldsUserConfig(system.control.torrentlist.datagrid("options").columns[0]);
-system.saveUserConfig()},onHeaderContextMenu:function(i){i.preventDefault();b||a();b.menu("show",{left:i.pageX,top:i.pageY})}})},"json");this.control.torrentlist.refresh=function(){system.control.torrentlist.datagrid("getPager").find(".pagination-load").click()}},resetTorrentListFieldsUserConfig:function(a){var b={};$.each(this.userConfig.torrentList.fields,function(c,d){b[d.field]=d});this.userConfig.torrentList.fields=[];$.each(a,function(c,d){var e=$.extend({},b[d.field]);e.width=d.width;e.hidden=
-d.hidden;system.userConfig.torrentList.fields.push(e)})},showContextMenu:function(a,b){var c=this.contextMenus[a];if(c)c.empty();else{c=$("<div/>").attr("class","easyui-menu").css({"min-width":"180px"}).appendTo(this.panel.main);this.contextMenus[a]=c;c.menu()}var d=null;switch(a){case "torrent-list":d=["start","pause","-","rename","remove","recheck","-","morepeers","changeDownloadDir","copyPath","-","menu-queue-move-top","menu-queue-move-up","menu-queue-move-down","menu-queue-move-bottom","magnetLink"];
-if(this.config.nav.labels){d.push("-");d.push("setLabels")}var e=this.panel.toolbar,f;for(f in d){var g=d[f];if(g=="-")$("<div class='menu-sep'></div>").appendTo(c);else{var h=e.find("#toolbar_"+g);if(h.length>0)c.menu("appendItem",{text:h.attr("title"),id:g,iconCls:h.linkbutton("options").iconCls,disabled:h.linkbutton("options").disabled,onclick:function(){system.panel.toolbar.find("#toolbar_"+$(this).attr("id")).click()}});else{h=$("#"+g);if(h.length>0)c.menu("appendItem",{text:h.attr("title"),
-id:g,iconCls:h.attr("id").replace("menu-queue-move","iconfont tr-icon"),disabled:e.find("#toolbar_queue").linkbutton("options").disabled,onclick:function(){$("#"+$(this).attr("id")).click()}});else(h=this.getContentMenuWithKey(g,c))&&c.menu("appendItem",h)}h=null}}d=$("#copyPath",c);d.attr({"data-clipboard-action":"copy","data-clipboard-target":"#clipboard-source"});new ClipboardJS(d.get(0))}c.menu("show",{left:b.pageX,top:b.pageY,hideOnUnhover:false});d=c=null},getContentMenuWithKey:function(a,b){switch(a){case "setLabels":return{id:"setLabels",
-text:system.lang.menus.setLabels,iconCls:"iconfont tr-icon-labels",disabled:this.checkedRows.length==0,onclick:function(){var c=system.checkedRows,d=[],e;for(e in c)d.push(c[e].hashString);d.length!=0&&system.openDialogFromTemplate({id:"dialog-torrent-setLabels",options:{title:system.lang.dialog["torrent-setLabels"].title,width:520,height:200},datas:{hashs:d}})}};case "magnetLink":return{id:"magnetLink",text:system.lang.menus.copyMagnetLink,iconCls:"iconfont tr-icon-labels",disabled:this.checkedRows.length==
-0,onclick:function(){system.getTorrentMagnetLink(function(c){system.copyToClipboard(c);b.css("display","block")})}}}},formetTorrentLabels:function(a,b){var c=$("<div style='position: relative;'/>");if(a){if(typeof a=="string")a=a.split(",");for(var d=0;d<a.length;d++){var e=this.config.labels[a[d]];if(e)$("<span class='user-label'/>").html(e.name).css({"background-color":e.color,color:getGrayLevel(e.color)>0.5?"#000":"#fff"}).appendTo(c)}}d=$("<button onclick='javascript:system.setTorrentLabels(this,\""+
-b+'");\' data-options="iconCls:\'iconfont tr-icon-labels\',plain:true" class="easyui-linkbutton user-label-set"/>').appendTo(c);d.linkbutton();d.find("span").first().attr({title:system.lang.dialog["torrent-setLabels"].title});return c.get(0).outerHTML},setTorrentLabels:function(a,b){system.openDialogFromTemplate({id:"dialog-torrent-setLabels",options:{title:system.lang.dialog["torrent-setLabels"].title,width:520,height:200},datas:{hashs:[b]},type:1,source:$(a)})},checkTorrentRow:function(a,b){this.checkedRows=
-this.control.torrentlist.datagrid("getChecked");this.showCheckedInStatus();if(a=="all"){if(this.control.torrentlist.datagrid("getRows").length!=0){$("#toolbar_start, #toolbar_pause, #toolbar_remove, #toolbar_recheck, #toolbar_changeDownloadDir,#toolbar_morepeers,#toolbar_copyPath",this.panel.toolbar).linkbutton({disabled:b});$("#toolbar_rename, #toolbar_morepeers",this.panel.toolbar).linkbutton({disabled:true});this.panel.toolbar.find("#toolbar_queue").menubutton("disable")}}else if(this.checkedRows.length==
-0){$("#toolbar_start, #toolbar_pause, #toolbar_rename, #toolbar_remove, #toolbar_recheck, #toolbar_changeDownloadDir,#toolbar_morepeers,#toolbar_copyPath",this.panel.toolbar).linkbutton({disabled:true});this.panel.toolbar.find("#toolbar_queue").menubutton("disable")}else if(this.checkedRows.length==1){$("#toolbar_remove, #toolbar_rename, #toolbar_changeDownloadDir,#toolbar_copyPath",this.panel.toolbar).linkbutton({disabled:false});this.panel.toolbar.find("#toolbar_queue").menubutton("enable");switch(transmission.torrents.all[b.id].status){case transmission._status.stopped:this.panel.toolbar.find("#toolbar_start, #toolbar_recheck").linkbutton({disabled:false});
-this.panel.toolbar.find("#toolbar_pause, #toolbar_morepeers").linkbutton({disabled:true});break;case transmission._status.check:case transmission._status.checkwait:this.panel.toolbar.find("#toolbar_start, #toolbar_pause, #toolbar_recheck, #toolbar_morepeers").linkbutton({disabled:true});break;default:this.panel.toolbar.find("#toolbar_start, #toolbar_recheck").linkbutton({disabled:true});this.panel.toolbar.find("#toolbar_pause, #toolbar_morepeers").linkbutton({disabled:false})}}else{$("#toolbar_start, #toolbar_pause, #toolbar_remove, #toolbar_recheck, #toolbar_changeDownloadDir,#toolbar_copyPath",
-this.panel.toolbar).linkbutton({disabled:false});$("#toolbar_rename, #toolbar_morepeers",this.panel.toolbar).linkbutton({disabled:true});this.panel.toolbar.find("#toolbar_queue").menubutton("disable")}},showCheckedInStatus:function(){if(this.checkedRows.length>0){this.panel.status_text.empty();this.showStatus(undefined,0);var a=[],b=this.lang.system.status.checked.replace("%n",this.checkedRows.length),c=[];$("<div style='padding: 5px;'/>").html(b).appendTo(this.panel.status_text);for(b=0;b<this.checkedRows.length;b++){var d=
-this.checkedRows[b];a.push({value:b,text:b+1+". "+d.name});$.inArray(d.downloadDir,c)===-1&&c.push(d.downloadDir)}$("<div/>").appendTo(this.panel.status_text).datalist({data:a});$(".datalist>.panel-body",this.panel.status_text).css({border:0});$("#button-cancel-checked").show();$("#clipboard-source").val(c.join("\n"))}else{$("#button-cancel-checked").hide();this.panel.status_text.empty();$("#clipboard-source").val("")}},copyToClipboard:function(a){var b=document.getElementById("copy_to_clipboard_textarea");
-b||(b=document.createElement("textarea"));b.id="copy_to_clipboard_textarea";b.style.display="block";b.value=a;document.body.appendChild(b);b.select();document.execCommand("copy");b.style.display="none"},initToolbar:function(){this.panel.toolbar.find("#toolbar_label_reload_time").html(this.lang.toolbar["reload-time"]);this.panel.toolbar.find("#toolbar_label_reload_time_unit").html(this.lang.toolbar["reload-time-unit"]);this.panel.toolbar.find("#toolbar_reload_time").numberspinner({value:this.config.reloadStep/
-1E3,min:3,disabled:!this.config.autoReload,onChange:function(){var a=this.value;if($.isNumeric(a)){system.config.reloadStep=a*1E3;system.saveConfig()}}});this.panel.toolbar.find("#toolbar_autoreload").linkbutton({text:this.config.autoReload?this.lang.toolbar["autoreload-enabled"]:this.lang.toolbar["autoreload-disabled"],iconCls:this.config.autoReload?"icon-enabled":"icon-disabled"}).attr("title",this.config.autoReload?this.lang.toolbar.tip["autoreload-disabled"]:this.lang.toolbar.tip["autoreload-enabled"]).click(function(){if(system.config.autoReload){system.config.autoReload=
-false;clearTimeout(system.autoReloadTimer);system.panel.toolbar.find("#toolbar_reload_time").numberspinner("disable")}else{system.config.autoReload=true;system.reloadData();system.panel.toolbar.find("#toolbar_reload_time").numberspinner("enable")}system.saveConfig();$(this).linkbutton({text:system.config.autoReload?system.lang.toolbar["autoreload-enabled"]:system.lang.toolbar["autoreload-disabled"],iconCls:system.config.autoReload?"icon-enabled":"icon-disabled"}).attr("title",system.config.autoReload?
-system.lang.toolbar.tip["autoreload-disabled"]:system.lang.toolbar.tip["autoreload-enabled"])});this.panel.toolbar.find("#toolbar_add_torrents").linkbutton({text:this.lang.toolbar["add-torrent"],disabled:false}).attr("title",this.lang.toolbar.tip["add-torrent"]).click(function(){system.openDialogFromTemplate({id:"dialog-torrent-add",options:{title:system.lang.toolbar["add-torrent"],width:620,height:system.config.nav.labels?600:400,resizable:true}})});this.panel.toolbar.find("#toolbar_start_all").linkbutton({disabled:false}).attr("title",
-this.lang.toolbar.tip["start-all"]).click(function(){var a=$(this),b=a.linkbutton("options").iconCls;a.linkbutton({disabled:true,iconCls:"icon-loading"});transmission.exec({method:"torrent-start"},function(){a.linkbutton({iconCls:b,disabled:false});a=null})});this.panel.toolbar.find("#toolbar_pause_all").linkbutton({disabled:false}).attr("title",this.lang.toolbar.tip["pause-all"]).click(function(){var a=$(this),b=a.linkbutton("options").iconCls;a.linkbutton({disabled:true,iconCls:"icon-loading"});
-transmission.exec({method:"torrent-stop"},function(){a.linkbutton({iconCls:b,disabled:false});a=null})});this.panel.toolbar.find("#toolbar_start").linkbutton({disabled:true}).attr("title",this.lang.toolbar.tip.start).click(function(){system.changeSelectedTorrentStatus("start",$(this))});this.panel.toolbar.find("#toolbar_pause").linkbutton({disabled:true}).attr("title",this.lang.toolbar.tip.pause).click(function(){system.changeSelectedTorrentStatus("stop",$(this))});this.panel.toolbar.find("#toolbar_recheck").linkbutton({disabled:true}).attr("title",
-this.lang.toolbar.tip.recheck).click(function(){var a=system.control.torrentlist.datagrid("getChecked");if(a.length>0)if(a.length==1)if(transmission.torrents.all[a[0].id].percentDone>0)confirm(system.lang.toolbar.tip["recheck-confirm"])&&system.changeSelectedTorrentStatus("verify",$(this));else system.changeSelectedTorrentStatus("verify",$(this));else confirm(system.lang.toolbar.tip["recheck-confirm"])&&system.changeSelectedTorrentStatus("verify",$(this))});this.panel.toolbar.find("#toolbar_morepeers").linkbutton({disabled:true}).click(function(){system.changeSelectedTorrentStatus("reannounce",
-$(this))});this.panel.toolbar.find("#toolbar_remove").linkbutton({disabled:true}).attr("title",this.lang.toolbar.tip.remove).click(function(){var a=system.control.torrentlist.datagrid("getChecked"),b=[],c;for(c in a)b.push(a[c].id);b.length!=0&&system.openDialogFromTemplate({id:"dialog-torrent-remove-confirm",options:{title:system.lang.dialog["torrent-remove"].title,width:350,height:150},datas:{ids:b}})});this.panel.toolbar.find("#toolbar_rename").linkbutton({disabled:true}).click(function(){var a=
-system.control.torrentlist.datagrid("getChecked");a.length!=0&&system.openDialogFromTemplate({id:"dialog-torrent-rename",options:{title:system.lang.dialog["torrent-rename"].title,width:520,height:200,resizable:true},datas:{id:a[0].id}})});this.panel.toolbar.find("#toolbar_changeDownloadDir").linkbutton({disabled:true}).attr("title",this.lang.toolbar.tip["change-download-dir"]).click(function(){var a=system.control.torrentlist.datagrid("getChecked"),b=[],c;for(c in a)b.push(a[c].id);b.length!=0&&system.openDialogFromTemplate({id:"dialog-torrent-changeDownloadDir",
-options:{title:system.lang.dialog["torrent-changeDownloadDir"].title,width:520,height:200},datas:{ids:b}})});this.panel.toolbar.find("#toolbar_alt_speed").linkbutton().attr("title",this.lang.toolbar.tip["alt-speed"]).click(function(){var a=$(this),b=false;if(a.linkbutton("options").iconCls=="iconfont tr-icon-rocket")b=true;transmission.exec({method:"session-set",arguments:{"alt-speed-enabled":b}},function(c){if(c.result=="success"){system.serverConfig["alt-speed-enabled"]=b;a.linkbutton({iconCls:"iconfont tr-icon-"+
-(b?"woniu":"rocket")});b?$("#status_alt_speed").show():$("#status_alt_speed").hide()}});a.linkbutton({iconCls:"icon-loading"})});this.panel.toolbar.find("#toolbar_config").linkbutton().attr("title",this.lang.toolbar.tip["system-config"]).click(function(){system.openDialogFromTemplate({id:"dialog-system-config",options:{title:system.lang.toolbar["system-config"],width:680,height:500,resizable:true}})});this.panel.toolbar.find("#toolbar_reload").linkbutton().attr("title",this.lang.toolbar.tip["system-reload"]).click(function(){system.reloadData()});
-this.panel.toolbar.find("#toolbar_search").searchbox({searcher:function(a){system.searchTorrents(a)},prompt:this.lang.toolbar["search-prompt"]});this.panel.toolbar.find("#toolbar_copyPath").linkbutton().attr("title",this.lang.toolbar.tip["copy-path-to-clipboard"])},initStatusBar:function(){this.panel.statusbar.find("#status_title_downloadspeed").html(this.lang.statusbar.downloadspeed);this.panel.statusbar.find("#status_title_uploadspeed").html(this.lang.statusbar.uploadspeed)},connect:function(){this.showStatus(this.lang.system.status.connect,
-0);transmission.on.torrentCountChange=function(){system.reloadTorrentBaseInfos()};transmission.on.postError=function(){};transmission.init({islocal:true},function(){system.reloadSession(true);system.getServerStatus()})},reloadSession:function(a){transmission.getSession(function(b){system.serverConfig=b;$("#status_version").html("Transmission "+system.lang.statusbar.version+b.version+", RPC: "+b["rpc-version"]+", WEB Control: "+system.version+"("+system.codeupdate+")");if(b["alt-speed-enabled"]==true){system.panel.toolbar.find("#toolbar_alt_speed").linkbutton({iconCls:"iconfont tr-icon-woniu"});
-$("#status_alt_speed").show()}else{system.panel.toolbar.find("#toolbar_alt_speed").linkbutton({iconCls:"iconfont tr-icon-rocket"});$("#status_alt_speed").hide()}system.downloadDir=b["download-dir"];transmission.downloadDirs.length==0&&transmission.downloadDirs.push(system.downloadDir);parseInt(system.serverConfig["rpc-version"])>=15?transmission.getFreeSpace(system.downloadDir,function(c){system.serverConfig["download-dir-free-space"]=c.arguments["size-bytes"];system.showFreeSpace(c.arguments["size-bytes"])}):
-system.showFreeSpace(system.serverConfig["download-dir-free-space"]);a&&system.showStatus(system.lang.system.status.connected)})},showFreeSpace:function(a){a=a;a=a==-1?system.lang["public"]["text-unknown"]:formatSize(a);$("#status_freespace").text(system.lang.dialog["system-config"]["download-dir-free-space"]+" "+a)},reloadTorrentBaseInfos:function(a,b){if(!this.reloading){clearTimeout(this.autoReloadTimer);this.reloading=true;var c={trackers:transmission.trackers,folders:transmission.torrents.folders};
-transmission.torrents.getallids(function(d){var e=[],f;for(f in d)e.push(d[f].id);d=transmission.torrents.getErrorIds(e,true);d.length>0?transmission.torrents.getallids(function(){system.resetTorrentInfos(c)},d):system.resetTorrentInfos(c)},a,b)}},resetTorrentInfos:function(a){this.resetNavTorrentStatus();this.resetNavServers(a);this.resetNavStatistics();this.resetNavFolders(a);this.resetNavLabels();$.ua.browser.name=="Firefox"&&$.ua.browser.major<60&&system.panel.left.find("span.nav-total-size").css({"margin-top":"-19px"})},
-resetNavTorrentStatus:function(){var a=this.currentTorrentId;transmission.torrents.status[transmission._status.stopped]?system.updateTreeNodeText("paused",system.lang.tree.paused+this.showNodeMoreInfos(transmission.torrents.status[transmission._status.stopped].length)):system.updateTreeNodeText("paused",system.lang.tree.paused);transmission.torrents.status[transmission._status.seed]?system.updateTreeNodeText("sending",system.lang.tree.sending+this.showNodeMoreInfos(transmission.torrents.status[transmission._status.seed].length)):
-system.updateTreeNodeText("sending",system.lang.tree.sending);if(transmission.torrents.status[transmission._status.seedwait]){var b=system.panel.left.tree("find","sending"),c=system.panel.left.tree("getChildren",b.target),d=system.lang.tree.wait+this.showNodeMoreInfos(transmission.torrents.status[transmission._status.seedwait].length);c.length>0?system.updateTreeNodeText(c[0].id,d):system.appendTreeNode(b,[{id:"seedwait",text:d,iconCls:"iconfont tr-icon-wait"}])}else system.removeTreeNode("seedwait");
-transmission.torrents.status[transmission._status.check]?system.updateTreeNodeText("check",system.lang.tree.check+this.showNodeMoreInfos(transmission.torrents.status[transmission._status.check].length)):system.updateTreeNodeText("check",system.lang.tree.check);if(transmission.torrents.status[transmission._status.checkwait]){b=system.panel.left.tree("find","check");c=system.panel.left.tree("getChildren",b.target);d=system.lang.tree.wait+this.showNodeMoreInfos(transmission.torrents.status[transmission._status.checkwait].length);
-c.length>0?system.updateTreeNodeText(c[0].id,d):system.appendTreeNode(b,[{id:"checkwait",text:d,iconCls:"iconfont tr-icon-wait"}])}else system.removeTreeNode("checkwait");transmission.torrents.status[transmission._status.download]?system.updateTreeNodeText("downloading",system.lang.tree.downloading+this.showNodeMoreInfos(transmission.torrents.status[transmission._status.download].length)):system.updateTreeNodeText("downloading",system.lang.tree.downloading);if(transmission.torrents.status[transmission._status.downloadwait]){b=
-system.panel.left.tree("find","downloading");c=system.panel.left.tree("getChildren",b.target);d=system.lang.tree.wait+this.showNodeMoreInfos(transmission.torrents.status[transmission._status.downloadwait].length);c.length>0?system.updateTreeNodeText(c[0].id,d):system.appendTreeNode(b,[{id:"downloadwait",text:d,iconCls:"iconfont tr-icon-wait"}])}else system.removeTreeNode("downloadwait");system.updateTreeNodeText("actively",system.lang.tree.actively+this.showNodeMoreInfos(transmission.torrents.actively.length));
-system.updateTreeNodeText("error",system.lang.tree.error+this.showNodeMoreInfos(transmission.torrents.error.length));system.updateTreeNodeText("warning",system.lang.tree.warning+this.showNodeMoreInfos(transmission.torrents.warning.length));b=system.panel.left.tree("getSelected");if(b!=null){c=system.control.torrentlist.datagrid("options").pageNumber;system.loadTorrentToList({node:b,page:c})}a!=0&&system.control.torrentlist.datagrid("selectRecord",a);system.reloading=false;if(system.config.autoReload)system.autoReloadTimer=
-setTimeout(function(){system.reloadData()},system.config.reloadStep);system.updateTreeNodeText("torrent-all",system.lang.tree.all+this.showNodeMoreInfos(transmission.torrents.count,transmission.torrents.totalSize))},resetNavServers:function(a){var b=this.panel.left.tree("find","servers");if(this.config.nav.servers){if(b){var c=b.state;this.removeTreeNode("servers-loading")}else{this.appendTreeNode(null,[{id:"servers",text:this.lang.tree.servers,state:"closed",iconCls:"iconfont tr-icon-servers"}]);
-b=this.panel.left.tree("find","servers")}var d=this.panel.left.tree("find","btservers"),e=d?d.state:"close";if(!d&&system.config.showBTServers){this.appendTreeNode(b,[{id:"btservers",text:"BT",state:"open",iconCls:"iconfont tr-icon-bt"}]);d=this.panel.left.tree("find","btservers")}for(var f in transmission.trackers){var g=transmission.trackers[f];if(g.isBT)if(!system.config.showBTServers)continue;var h=system.panel.left.tree("find",g.nodeid),i=g.name+this.showNodeMoreInfos(g.count,g.size);h?system.updateTreeNodeText(g.nodeid,
-i,g.connected?"iconfont tr-icon-server":"iconfont tr-icon-server-error"):system.appendTreeNode(g.isBT?d:b,[{id:g.nodeid,text:i,iconCls:g.connected?"iconfont tr-icon-server":"iconfont tr-icon-server-error"}]);a.trackers[g.nodeid]=null}c=="closed"&&this.panel.left.tree("collapse",b.target);system.config.showBTServers&&d&&e=="closed"&&this.panel.left.tree("collapse",d.target);for(f in a.trackers)(g=a.trackers[f])&&system.removeTreeNode(g.nodeid)}else b&&this.panel.left.tree("remove",b.target)},resetNavStatistics:function(){if(this.config.nav.statistics){var a=
-"uploadedBytes,downloadedBytes,filesAdded,sessionCount,secondsActive".split(",");$.each(a,function(b,c){switch(c){case "uploadedBytes":case "downloadedBytes":system.updateTreeNodeText(c,system.lang.tree.statistics[c]+" "+formatSize(system.serverSessionStats["cumulative-stats"][c]));system.updateTreeNodeText("current-"+c,system.lang.tree.statistics[c]+" "+formatSize(system.serverSessionStats["current-stats"][c]));break;case "secondsActive":system.updateTreeNodeText(c,system.lang.tree.statistics[c]+
-" "+getTotalTime(system.serverSessionStats["cumulative-stats"][c]*1E3));system.updateTreeNodeText("current-"+c,system.lang.tree.statistics[c]+" "+getTotalTime(system.serverSessionStats["current-stats"][c]*1E3));break;default:system.updateTreeNodeText(c,system.lang.tree.statistics[c]+" "+system.serverSessionStats["cumulative-stats"][c]);system.updateTreeNodeText("current-"+c,system.lang.tree.statistics[c]+" "+system.serverSessionStats["current-stats"][c])}})}else(a=this.panel.left.tree("find","statistics"))&&
-this.panel.left.tree("remove",a.target)},resetNavFolders:function(a){if(this.config.nav.folders){for(var b in transmission.torrents.folders)a.folders[transmission.torrents.folders[b].nodeid]=null;this.loadFolderList(a.folders)}else{this.initUIStatus();(a=this.panel.left.tree("find","folders"))&&this.panel.left.tree("remove",a.target)}},resetNavLabels:function(a){if(this.config.nav.labels){if(a){var b=this.panel.left.tree("getChildren",this.panel.left.tree("find","labels").target);for(a=0;a<b.length;a++)this.panel.left.tree("remove",
-b[a].target)}for(a=0;a<this.config.labels.length;a++){b=this.config.labels[a];var c="label-"+this.getValidTreeKey(b.name);d=this.panel.left.tree("find",c);if(!d){this.appendTreeNode("labels",[{id:c,text:b.name,labelIndex:a,iconCls:"iconfont tr-icon-label"}]);d=this.panel.left.tree("find",c);$(".tree-icon",d.target).css({color:b.color});$(".tree-title",d.target).addClass("user-label").css({"background-color":b.color,color:getGrayLevel(b.color)>0.5?"#000":"#fff"})}}}else{var d=this.panel.left.tree("find",
-"labels");d&&this.panel.left.tree("remove",d.target)}},showNodeMoreInfos:function(a,b){var c="";if(a>0)c=" <span class='nav-torrents-number'>("+a+")</span>";if(b>0)c+="<span class='nav-total-size'>["+formatSize(b)+"]</span>";return c},getServerStatus:function(){if(!this.reloading){clearTimeout(this.autoReloadTimer);this.reloading=true;transmission.getStatus(function(a){system.reloading=false;$("#status_downloadspeed").html(formatSize(a.downloadSpeed,false,"speed"));$("#status_uploadspeed").html(formatSize(a.uploadSpeed,
-false,"speed"));system.serverSessionStats=a;if(a.torrentCount==0){(a=system.panel.left.tree("find","servers"))&&system.panel.left.tree("remove",a.target);system.updateTreeNodeText("torrent-all",system.lang.tree.all)}})}},showStatus:function(a,b){$("#m_status").panel("options").collapsed&&$("#layout_left").layout("expand","south");this.panel.status_text.show();a&&this.panel.status_text.html(a);if(b!=0){if(b==undefined)b=3E3;this.panel.status_text.fadeOut(b,function(){$("#layout_left").layout("collapse",
-"south")})}},updateTreeNodeText:function(a,b,c){if(a=this.panel.left.tree("find",a)){b={target:a.target,text:b};if(c!=undefined)b.iconCls=c;this.panel.left.tree("update",b)}},appendTreeNode:function(a,b){var c=null;(c=typeof a=="string"?this.panel.left.tree("find",a):a)?this.panel.left.tree("append",{parent:c.target,data:b}):this.panel.left.tree("append",{data:b})},removeTreeNode:function(a){(a=this.panel.left.tree("find",a))&&this.panel.left.tree("remove",a.target)},loadTorrentToList:function(a){if(transmission.torrents.all){jQuery.extend({node:null,
-page:1},a);if(a.node){var b=null,c=this.panel.left.tree("getParent",a.node.target)||{id:""},d=this.panel.left.data("currentNodeId");if(d!=a.node.id){this.control.torrentlist.datagrid("uncheckAll");this.control.torrentlist.datagrid({pageNumber:1});d=a.node.id}this.panel.left.data("currentNodeId",d);switch(c.id){case "servers":case "btservers":b=a.node.id=="btservers"?transmission.torrents.btItems:transmission.trackers[a.node.id].torrents;break;default:switch(a.node.id){case "torrent-all":case "servers":b=
-transmission.torrents.all;break;case "paused":b=transmission.torrents.status[transmission._status.stopped];break;case "sending":b=transmission.torrents.status[transmission._status.seed];break;case "seedwait":b=transmission.torrents.status[transmission._status.seedwait];break;case "check":b=transmission.torrents.status[transmission._status.check];break;case "checkwait":b=transmission.torrents.status[transmission._status.checkwait];break;case "downloading":b=transmission.torrents.status[transmission._status.download];
-break;case "downloadwait":b=transmission.torrents.status[transmission._status.downloadwait];break;case "actively":b=transmission.torrents.actively;break;case "error":b=transmission.torrents.error;break;case "warning":b=transmission.torrents.warning;break;case "search-result":b=transmission.torrents.searchResult;break;case "btservers":b=transmission.torrents.btItems;break;default:if(a.node.id.indexOf("folders-")!=-1){var e=transmission.torrents.folders[a.node.id];if(e)if(this.config.hideSubfolders){b=
-[];for(var f=0;f<e.torrents.length;f++){c=e.torrents[f];c.downloadDir.replace(/[\\|\/]/g,"")==a.node.path&&b.push(c)}}else b=e.torrents}else if(a.node.id.indexOf("label-")!=-1){d=parseInt(a.node.labelIndex);b=[];for(e in transmission.torrents.all){var g=transmission.torrents.all[e];(c=this.config.labelMaps[g.hashString])&&$.inArray(d,c)!=-1&&b.push(g)}}}}if(this.config.defaultSelectNode!=a.node.id){this.control.torrentlist.datagrid("loadData",[]);this.config.defaultSelectNode=a.node.id;this.saveConfig()}a=
-[];for(f in b){if(!b[f])return;c=this.lang.torrent["status-text"][b[f].status];parseFloat(b[f].percentDone*100).toFixed(2);c==transmission._status.check&&parseFloat(b[f].recheckProgress*100).toFixed(2);if(b[f].error!=0)c="<span class='text-status-error'>"+c+"</span>";else if(b[f].warning)c="<span class='text-status-warning' title='"+b[f].warning+"'>"+c+"</span>";e={};e=$.extend(e,b[f]);e.status=c;e.statusCode=b[f].status;e.completeSize=Math.max(0,b[f].totalSize-b[f].leftUntilDone);e.leecherCount=
-b[f].leecher;e.seederCount=b[f].seeder;if(c=this.config.labelMaps[e.hashString])e.labels=c;a.push(e)}this.updateTorrentCurrentPageDatas(a);this.initShiftCheck()}}},initShiftCheck:function(){var a=$("#m_list div.datagrid-cell-check input:checkbox");a.off("click.Shift");var b=null,c=this.control.torrentlist;a.on("click.Shift",function(d){if(b)if(d.shiftKey){var e=a.index(this),f=a.index(b);d=b.checked;var g=Math.max(e,f)+1;for(e=Math.min(e,f);e<g;e++)d?c.datagrid("checkRow",e):c.datagrid("uncheckRow",
-e)}b=this})},updateTorrentCurrentPageDatas:function(a){var b=this.control.torrentlist.datagrid("getRows");if(a.length==0&&b.length>0)this.control.torrentlist.datagrid("loadData",[]);else{var c=this.control.torrentlist.datagrid("options"),d=null;if(c.sortName){d=c.sortName;a=a.sort(arrayObjectSort(d,c.sortOrder))}if(b.length==0||a.length!=this.control.torrentlist.datagrid("getData").total&&a.length>c.pageSize)this.control.torrentlist.datagrid({loadFilter:pagerFilter,pageNumber:c.pageNumber,sortName:d,
-sortOrder:c.sortOrder}).datagrid("loadData",a);else{this.control.torrentlist.datagrid("getData").originalRows=a;d=(c.pageNumber-1)*parseInt(c.pageSize);c=d+parseInt(c.pageSize);a=a.slice(d,c);c={};d={};for(var e in transmission.torrents.recently){var f=transmission.torrents.recently[e];c[f.id]=true}for(e in a){f=a[e];d[f.id]=f}var g={};for(e=b.length-1;e>=0;e--){f=b[e];var h=d[f.id];if(h)if(c[f.id]){this.control.torrentlist.datagrid("updateRow",{index:e,row:h});g[f.id]=f}else if(transmission.torrents.removed)if(transmission.torrents.removed.length>
-0&&$.inArray(f.id,transmission.torrents.removed)!=-1)this.control.torrentlist.datagrid("deleteRow",e);else g[f.id]=f;else g[f.id]=f;else this.control.torrentlist.datagrid("deleteRow",e)}for(e in a){f=a[e];g[f.id]||this.control.torrentlist.datagrid("appendRow",f)}}}},getTorrentNameBar:function(a){var b="",c=a.name;switch(a.status){case transmission._status.stopped:b="iconlabel icon-pause-small";break;case transmission._status.check:b="iconlabel icon-checking";break;case transmission._status.download:b=
-"iconlabel icon-down";break;case transmission._status.seed:b="iconlabel icon-up";break;case transmission._status.seedwait:case transmission._status.downloadwait:case transmission._status.checkwait:b="iconlabel icon-wait"}c+="\n"+a.downloadDir;if(a.warning){b="iconlabel icon-warning-type1";c+="\n\n"+this.lang["public"]["text-info"]+": "+a.warning}if(a.error!=0){b="iconlabel icon-exclamation";c+="\n\n"+this.lang["public"]["text-info"]+": "+a.errorString}return'<span class="'+b+'" title="'+c+'">'+a.name+
-"</span>"},getTorrentProgressBar:function(a,b){a+="%";var c="",d=0;d=typeof b=="object"?b.status:b;switch(d){case transmission._status.stopped:c="torrent-progress-stop";break;case transmission._status.checkwait:case transmission._status.check:c="torrent-progress-check";break;case transmission._status.downloadwait:case transmission._status.download:c="torrent-progress-download";break;case transmission._status.seedwait:case transmission._status.seed:c="torrent-progress-seed"}if(typeof b=="object"){if(b.warning)c=
-"torrent-progress-warning";if(b.error!=0)c="torrent-progress-error"}return'<div class="torrent-progress" title="'+a+'"><div class="torrent-progress-text">'+a+'</div><div class="torrent-progress-bar '+c+'" style="width:'+a+';"></div></div>'},addTorrentsToServer:function(a,b,c,d,e){var f=b-a.length,g=a.shift();if(g){this.showStatus(this.lang.system.status.queue+(f+1)+"/"+b+"<br/>"+g,0);transmission.addTorrentFromUrl(g,d,c,function(h){system.addTorrentsToServer(a,b,c,d,e);e!=null&&h.hashString!=null&&
-system.saveLabelsConfig(h.hashString,e)})}else{this.showStatus(this.lang.system.status.queuefinish);this.getServerStatus();e!=null&&system.saveConfig()}},changeSelectedTorrentStatus:function(a,b,c){var d=this.control.torrentlist.datagrid("getChecked"),e=[];a||(a="start");for(var f in d)e.push(d[f].id);c||(c="torrent-"+a);if(e.length>0){if(b){var g=b.linkbutton("options").iconCls;b.linkbutton({disabled:true,iconCls:"icon-loading"})}transmission.exec({method:c,arguments:{ids:e}},function(){b&&b.linkbutton({iconCls:g});
-system.control.torrentlist.datagrid("uncheckAll");system.reloadTorrentBaseInfos()})}},getTorrentMagnetLink:function(a){var b=this.control.torrentlist.datagrid("getChecked"),c=[],d;for(d in b)c.push(b[d].id);transmission.torrents.getMagnetLink(c,a)},searchTorrents:function(a){if(a!=""){var b=transmission.torrents.search(a);if(b==null||b.length==0)this.removeTreeNode("search-result");else{var c=this.panel.left.tree("find","search-result");a=this.lang.tree["search-result"]+" : "+a+" ("+b.length+")";
-if(c==null){this.appendTreeNode("torrent-all",[{id:"search-result",text:a,iconCls:"iconfont tr-icon-search"}]);c=this.panel.left.tree("find","search-result")}else this.panel.left.tree("update",{target:c.target,text:a});this.panel.left.tree("select",c.target)}}},getTorrentInfos:function(a){if(transmission.torrents.all[a])if(!transmission.torrents.all[a].infoIsLoading){if(this.currentTorrentId>0&&transmission.torrents.all[this.currentTorrentId])if(transmission.torrents.all[this.currentTorrentId].infoIsLoading)return;
-this.currentTorrentId=a;if(!this.panel.attribute.panel("options").collapsed){var b=transmission.torrents.all[a];b.infoIsLoading=true;var c="fileStats,trackerStats,peers,leftUntilDone,status,rateDownload,rateUpload,uploadedEver,uploadRatio,error,errorString";b.moreInfosTag||(c+=",files,trackers,comment,dateCreated,creator,downloadDir");transmission.torrents.getMoreInfos(c,a,function(d){b.infoIsLoading=false;if(d!=null){jQuery.extend(b,d[0]);if(system.currentTorrentId==0||system.currentTorrentId!=a)system.clearTorrentAttribute();
-else{b.completeSize=b.totalSize-b.leftUntilDone;b.moreInfosTag=true;system.fillTorrentBaseInfos(b);system.fillTorrentFileList(b);system.fillTorrentServerList(b);system.fillTorrentPeersList(b);system.fillTorrentConfig(b);transmission.torrents.all[a]=b;transmission.torrents.datas[a]=b}}})}}},clearTorrentAttribute:function(){system.panel.attribute.find("#torrent-files-table").datagrid("loadData",[]);system.panel.attribute.find("#torrent-servers-table").datagrid("loadData",[]);system.panel.attribute.find("#torrent-peers-table").datagrid("loadData",
-[]);system.panel.attribute.find("span[id*='torrent-attribute-value']").html("")},updateCurrentPageDatas:function(a,b,c){var d=c.datagrid("getRows"),e=c.datagrid("options"),f=null;if(e.sortName){f=e.sortName;b=b.sort(arrayObjectSort(f,e.sortOrder))}if(d.length==0||b.length!=c.datagrid("getData").total)c.datagrid({loadFilter:pagerFilter,pageNumber:1,sortName:f,sortOrder:e.sortOrder}).datagrid("loadData",b);else{c.datagrid("getData").originalRows=b;f=(e.pageNumber-1)*parseInt(e.pageSize);e=f+parseInt(e.pageSize);
-b=b.slice(f,e);e={};for(var g in b){f=b[g];e[f[a]]=f}for(g=d.length-1;g>=0;g--){f=d[g];(b=e[f[a]])?c.datagrid("updateRow",{index:g,row:b}):c.datagrid("deleteRow",g)}}},fillTorrentBaseInfos:function(a){$.each(a,function(b,c){switch(b){case "rateDownload":case "rateUpload":c=formatSize(c,true,"speed");break;case "totalSize":case "uploadedEver":case "leftUntilDone":case "completeSize":c=formatSize(c);break;case "addedDate":case "dateCreated":case "doneDate":c=formatLongTime(c);break;case "status":c=
-system.lang.torrent["status-text"][c];break;case "error":c==0?system.panel.attribute.find("#torrent-attribute-tr-error").hide():system.panel.attribute.find("#torrent-attribute-tr-error").show();break;case "remainingTime":c=c>=31536E8?"":getTotalTime(c);break;case "comment":c=system.replaceURI(c)}system.panel.attribute.find("#torrent-attribute-value-"+b).html(c)})},fillTorrentFileList:function(a){var b=a.files,c=a.fileStats,d=[],e=a.name.length+1,f;for(f in b){var g=b[f],h=c[f],i=parseFloat(h.bytesCompleted/
-g.length*100).toFixed(2);d.push({name:g.name==a.name?g.name:g.name.substr(e),index:f,bytesCompleted:h.bytesCompleted,percentDone:system.getTorrentProgressBar(i,transmission._status.download),length:g.length,wanted:system.lang.torrent.attribute.status[h.wanted],priority:'<span class="iconlabel icon-flag-'+h.priority+'">'+system.lang.torrent.attribute.priority[h.priority]+"</span>"})}this.updateCurrentPageDatas("index",d,system.panel.attribute.find("#torrent-files-table"))},fillTorrentServerList:function(a){var b=
-a.trackerStats,c=[],d;for(d in b){var e=b[d],f={},g;for(g in e)switch(g){case "lastAnnounceTime":case "nextAnnounceTime":f[g]=formatLongTime(e[g]);break;case "lastAnnounceSucceeded":case "lastAnnounceTimedOut":f[g]=system.lang.torrent.attribute.status[e[g]];break;default:f[g]=e[g]}c.push(f)}transmission.torrents.addTracker(a);this.updateCurrentPageDatas("id",c,system.panel.attribute.find("#torrent-servers-table"))},fillTorrentPeersList:function(a){a=a.peers;var b=[],c;for(c in a){var d=a[c],e={},
-f;for(f in d)e[f]=d[f];d=parseFloat(d.progress*100).toFixed(2);e.progress=system.getTorrentProgressBar(d,transmission._status.download);b.push(e)}this.updateCurrentPageDatas("address",b,system.panel.attribute.find("#torrent-peers-table"))},fillTorrentConfig:function(a){system.panel.attribute.find("#torrent-attribute-tabs").data("selectedIndex")==4&&transmission.torrents.getConfig(a.id,function(b){if(b!=null){jQuery.extend(transmission.torrents.all[system.currentTorrentId],b[0]);system.currentTorrentId!=
-0&&$.each(b[0],function(c,d){var e=false,f=false,g=false;switch(c){case "seedIdleMode":case "seedRatioMode":if(d==0){f=false;e=true}g=true;case "downloadLimited":case "uploadLimited":if(d==true||d==1)f=true;system.panel.attribute.find("input[enabledof='"+c+"']").prop("disabled",!f);g&&system.panel.attribute.find("#"+c).prop("indeterminate",e).data("_tag",d);system.panel.attribute.find("#"+c).prop("checked",f);break;default:system.panel.attribute.find("#"+c).val(d);system.panel.attribute.find("#"+
-c).numberspinner("setValue",d)}})}})},setFieldFormat:function(a){if(a.formatter)switch(a.formatter){case "size":a.formatter=function(b){return formatSize(b)};break;case "speed":a.formatter=function(b){return formatSize(b,true,"speed")};break;case "longtime":a.formatter=function(b){return formatLongTime(b)};break;case "progress":a.formatter=function(b,c){var d=parseFloat(b*100).toFixed(2);return system.getTorrentProgressBar(d,transmission.torrents.all[c.id])};break;case "_usename_":switch(a.field){case "name":a.formatter=
-function(b,c){return system.getTorrentNameBar(transmission.torrents.all[c.id])}}break;case "ratio":a.formatter=function(b){var c="";if(parseFloat(b)<1&&b!=-1)c="text-status-warning";return'<span class="'+c+'">'+(b==-1?"":b)+"</span>"};break;case "remainingTime":a.formatter=function(b){if(b>=31536E8)return"";return getTotalTime(b)};break;case "labels":a.formatter=function(b,c){return system.formetTorrentLabels(b,c.hashString)};break;case "color":a.formatter=function(b){return $("<span class='user-label'/>").html(b).css({"background-color":b,
-color:getGrayLevel(b)>0.5?"#000":"#fff"}).get(0).outerHTML}}},reloadData:function(){if(this.popoverCount>0)setTimeout(function(){system.reloadData()},2E3);else{this.reloadSession();this.reloading=false;this.getServerStatus();this.reloading=false;this.reloadTorrentBaseInfos()}},loadFolderList:function(a){this.removeTreeNode("folders-loading");for(var b in a){var c=a[b];c&&system.removeTreeNode(c.nodeid)}transmission.downloadDirs.length!=0&&timedChunk(transmission.downloadDirs,this.appendFolder,this,
-10,function(){$.ua.browser.name=="Firefox"&&$.ua.browser.major<60&&system.panel.left.find("span.nav-total-size").css({"margin-top":"-19px"});system.initUIStatus()})},appendFolder:function(a){if(a){var b="folders";a=a.replace(/\\/g,"/").split("/");var c="folders-",d="",e;for(e in a){var f=a[e];if(f!=""){d+=f;var g=this.B64.encode(f);c+=g.replace(/[+|\/|=]/g,"0");g=this.panel.left.tree("find",c);var h=transmission.torrents.folders[c];if(h){f=f+this.showNodeMoreInfos(h.count,h.size);if(g)this.updateTreeNodeText(c,
-f);else{this.appendTreeNode(b,[{id:c,path:d,text:f,iconCls:"iconfont tr-icon-file"}]);if(b!="folders"){g=this.panel.left.tree("find",b);this.panel.left.tree("collapse",g.target)}}b=c}else{this.debug("appendFolder:key",c);this.debug("appendFolder:name",f);this.debug("appendFolder:node",g)}}}}},replaceURI:function(a){return a.replace(/(http|https|ftp):\/\/([^/:]+)(:\d*)?([^# ]*)/ig,function(b){return'<a href="'+b+'" target="_blank">'+b+"</a>"})},readConfig:function(){this.readUserConfig();var a=this.getStorageData(this.configHead+
-".system");if(a)this.config=$.extend(true,this.config,JSON.parse(a));for(var b in this.storageKeys.dictionary)this.dictionary[b]=this.getStorageData(this.storageKeys.dictionary[b])},saveConfig:function(){this.setStorageData(this.configHead+".system",JSON.stringify(this.config));for(var a in this.storageKeys.dictionary)this.setStorageData(this.storageKeys.dictionary[a],this.dictionary[a]);this.saveUserConfig()},saveLabelsConfig:function(a,b){if(system.config.nav.labels)if(b.length==0)delete system.config.labelMaps[a];
-else system.config.labelMaps[a]=b},readUserConfig:function(){var a=window.localStorage[this.configHead];if(a){a=JSON.parse(a);this.userConfig=$.extend(true,this.userConfig,a)}},saveUserConfig:function(){window.localStorage[this.configHead]=JSON.stringify(this.userConfig)},uploadTorrentFile:function(a,b,c,d){if(window.FileReader){var e=$("input[id='"+a+"']")[0].files;$.each(e,function(f,g){transmission.addTorrentFromFile(g,b,c,d,e.length)})}else alert(system.lang["public"]["text-browsers-not-support-features"])},
-checkUpdate:function(){$.ajax({url:this.checkUpdateScript,dataType:"json",success:function(a){if(a&&a.tag_name){var b=a.created_at.substr(0,10).replace(/-/g,""),c=a.tag_name;if($.inArray(c,system.config.ignoreVersion)==-1)if(system.codeupdate<b){$("#area-update-infos").show();$("#msg-updateInfos").html(b+" -> "+a.name);var d=$("<div/>"),e=a.body.replace(/\r\n/g,"<br/>"),f=$("<div style='text-align:right;'/>").appendTo(d);$('<a href="https://github.com/ronggang/transmission-web-control/releases/latest" target="_blank" class="easyui-linkbutton" data-options="iconCls:\'iconfont tr-icon-github\'"/>').html(a.name+
-" ("+b+")").appendTo(f).linkbutton();$("<span/>").html(" ").appendTo(f);$('<a href="https://github.com/ronggang/transmission-web-control/wiki" target="_blank" class="easyui-linkbutton" data-options="iconCls:\'iconfont tr-icon-help\'"/>').html(system.lang["public"]["text-how-to-update"]).appendTo(f).linkbutton();$("<span/>").html(" ").appendTo(f);$("<button onclick=\"javascript:system.addIgnoreVersion('"+c+'\');" class="easyui-linkbutton" data-options="iconCls:\'iconfont tr-icon-cancel-checked\'"/>').html(system.lang["public"]["text-ignore-this-version"]).appendTo(f).linkbutton();
-$("<hr/>").appendTo(d);$("<div/>").html(e).appendTo(d);$("#button-download-update").webuiPopover({content:d.html(),backdrop:true})}else $("#area-update-infos").hide()}}})},addIgnoreVersion:function(a){if($.inArray(a,system.config.ignoreVersion)==-1){this.config.ignoreVersion.push(a);this.saveConfig()}$("#button-download-update").webuiPopover("hide");$("#area-update-infos").hide()},changeLanguages:function(a){if(!(a==this.lang.name||!a)){this.config.defaultLang=a;this.saveConfig();location.href="?lang="+
-a}},getStorageData:function(a,b){return window.localStorage[a]==null?b:window.localStorage[a]},setStorageData:function(a,b){window.localStorage[a]=b},openDialogFromTemplate:function(a){a=$.extend(true,{id:null,options:null,datas:null,type:0},a);if(a.id!=null){var b=a.id,c=a.options,d=a.datas,e=$("#"+b);if(e.length){d&&$.each(d,function(f,g){e.data(f,g)});if(a.type==0&&e.attr("type")==a.type){e.dialog("open");e.dialog({content:system.templates[b]});return}else{if(system.popoverCount!=0){setTimeout(function(){system.openDialogFromTemplate(a)},
-350);return}e.remove()}}c=$.extend(true,{title:"",width:100,height:100,resizable:false,cache:true,content:system.lang.dialog["system-config"].loading,modal:true},c);e=$("<div/>").attr({id:b,type:a.type}).appendTo(document.body);if(a.type==0)e.dialog(c);else{e.css({width:c.width,height:c.height}).data("popoverSource",a.source);$(a.source).webuiPopover({url:"#"+b,title:c.title,width:c.width,height:c.height-18,padding:false,onHide:function(f){$(a.source).webuiPopover("destroy");$("#"+b).remove();$(f).remove();
-system.popoverCount--;a.onClose&&a.onClose(a.source)},onShow:function(){system.popoverCount++}})}$.get(system.rootPath+"template/"+b+".html?time="+new Date,function(f){system.templates[b]=f;d&&$.each(d,function(g,h){$("#"+b).data(g,h)});if(a.type==0)$("#"+b).dialog({content:f});else{e.html(f);$.parser.parse("#"+b);$(a.source).webuiPopover("show")}})}},debug:function(a,b){window.console&&window.console.log&&window.console.log(a,b)},initThemes:function(){this.themes&&$("#select-themes").combobox({groupField:"group",
-data:this.themes,editable:false,panelHeight:"auto",onChange:function(a){var b=(a+";").split(";"),c=b[0];b=b[1]||"logo.png";$("#styleEasyui").attr("href","tr-web-control/script/easyui/themes/"+c+"/easyui.css");$("#logo").attr("src","tr-web-control/"+b);system.config.theme=a;system.saveConfig()},onLoadSuccess:function(){$(this).combobox("setValue",system.config.theme||"default")}})},getValidTreeKey:function(a){if(!a)return"";return this.B64.encode(a).replace(/[+|\/|=]/g,"0")}};
-$(document).ready(function(){$.getJSON(system.rootPath+"i18n/en.json").done(function(a){system.defaultLang=a});$.getJSON(system.rootPath+"i18n.json").done(function(a){system.languages=a;system.init(location.search.getQueryString("lang"),location.search.getQueryString("local"))})});
-function pagerFilter(a){if(typeof a.length=="number"&&typeof a.splice=="function")a={total:a.length,rows:a};var b=$(this),c=b.datagrid("options"),d=b.datagrid("getPager"),e=b.data("buttons");d.pagination({onSelectPage:function(h,i){c.pageNumber=h;c.pageSize=i;d.pagination("refresh",{pageNumber:h,pageSize:i});b.datagrid("loadData",a)},buttons:e});if(!a.originalRows)a.originalRows=a.rows;var f=(c.pageNumber-1)*parseInt(c.pageSize),g=f+parseInt(c.pageSize);a.rows=a.originalRows.slice(f,g);if(e&&e.length)for(f=
-0;f<e.length;f++){g=e[f];g.id&&g.title&&$("#"+g.id,d).attr("title",g.title)}return a};
+var system={version:"1.6.0",rootPath:"tr-web-control/",codeupdate:"20190724",configHead:"transmission-web-control",config:{autoReload:!0,reloadStep:5e3,pageSize:30,pagination:!0,pageList:[10,20,30,40,50,100,150,200,250,300],defaultSelectNode:null,autoExpandAttribute:!1,defaultLang:"",foldersShow:!1,theme:"default",showBTServers:!1,ui:{status:{tree:{},layout:{main:{},body:{},left:{}},panel:{},size:{nav:{},attribute:{}}}},hideSubfolders:!1,simpleCheckMode:!1,nav:{servers:!0,folders:!0,statistics:!0,labels:!1},labels:[],labelMaps:{},ignoreVersion:[]},storageKeys:{dictionary:{folders:"dictionary.folders"}},dictionary:{folders:null},checkUpdateScript:"https://api.github.com/repos/ronggang/transmission-web-control/releases/latest",contextMenus:{},panel:null,lang:null,reloading:!1,autoReloadTimer:null,downloadDir:"",islocal:!1,B64:new Base64,currentTorrentId:0,control:{tree:null,torrentlist:null},userConfig:{torrentList:{fields:[],sortName:null,sortOrder:"asc"}},serverConfig:null,serverSessionStats:null,templates:{},checkedRows:[],uiIsInitialized:!1,popoverCount:0,setlang:function(t,e){t||(t=this.config.defaultLang?this.config.defaultLang:navigator.language||navigator.browserLanguage),t||(t="zh-CN"),-1!=t.indexOf("-")&&(t=t.split("-")[0].toLocaleLowerCase()+"-"+t.split("-")[1].toLocaleUpperCase()),this.languages[t]||(t="en"),t=t.replace("-","_"),$.getJSON(system.rootPath+"i18n/"+t+".json",(function(s){s&&(system.lang=$.extend(!0,system.defaultLang,s)),system.resetLangText(),$.getScript(system.rootPath+"script/easyui/locale/easyui-lang-"+t+".js").done((function(t,s){e&&e()})).fail((function(t,s,n){$.getScript(system.rootPath+"script/easyui/locale/easyui-lang-en.js",(function(){e&&e()}))}))}))},init:function(t,e,s){this.readConfig(),this.lastUIStatus=JSON.parse(JSON.stringify(this.config.ui.status)),this.islocal=1==e,this.panel={main:$("#main"),top:$("#m_top"),toolbar:$("#m_toolbar"),left_layout:$("#m_left_layout"),left:$("#m_left"),body:$("#m_body"),layout_body:$("#layout_body"),layout_left:$("#layout_left"),list:$("#m_list"),attribute:$("#m_attribute"),bottom:$("#m_bottom"),title:$("#m_title"),status:$("#m_status"),statusbar:$("#m_statusbar"),status_text:$("#status_text"),droparea:$("#dropArea")},null==this.lang?this.setlang(t,(function(){system.initdata()})):this.initdata(),this.initThemes(),this.clipboard=new ClipboardJS("#toolbar_copyPath")},resetLangText:function(parent){parent||(parent=$);var items=parent.find("*[system-lang]");$.each(items,(function(key,item){var name=$(item).attr("system-lang");"["==name.substr(0,1)?$(item).html(eval("system.lang"+name)):$(item).html(eval("system.lang."+name))})),items=parent.find("*[system-tip-lang]"),$.each(items,(function(key,item){var name=$(item).attr("system-tip-lang");"["==name.substr(0,1)?$(item).attr("title",eval("system.lang"+name)):$(item).attr("title",eval("system.lang."+name))}))},initdata:function(){$(document).attr("title",this.lang.system.title+" "+this.version),$.fn.switchbutton.defaults.onText=this.lang.public["text-on"],$.fn.switchbutton.defaults.offText=this.lang.public["text-off"];var t=new Array,e="<span>"+this.lang.title.left+"</span>";if(t.length>1)for(var s in e+=t.join(""),this.panel.left_layout.panel("setTitle",e),this.lang.tree.toolbar.nav)switch($("#tree-toolbar-nav-"+s).linkbutton(),s){case"folders":system.config.foldersShow?$("tree-toolbar-nav-"+s).linkbutton({iconCls:"icon-enabled"}).data("status",1):$("tree-toolbar-nav-"+s).linkbutton({iconCls:"icon-disabled"}).data("status",0)}else this.panel.left_layout.panel("setTitle",e);if(e="<span>"+this.lang.title.list+"</span>",t.length=0,t.length>1)for(var s in e+=t.join(""),this.panel.body.panel("setTitle",e),this.lang["torrent-head"].buttons)switch($("#torrent-head-buttons-"+s).linkbutton(),s){case"autoExpandAttribute":system.config.autoExpandAttribute?$("#torrent-head-buttons-"+s).linkbutton({iconCls:"icon-enabled"}).data("status",1):$("#torrent-head-buttons-"+s).linkbutton({iconCls:"icon-disabled"}).data("status",0)}else this.panel.body.panel("setTitle",e);this.panel.status.panel("setTitle",this.lang.title.status),this.panel.attribute.panel({title:this.lang.title.attribute,onExpand:function(){0!=system.currentTorrentId&&$(this).data("isload")?system.getTorrentInfos(system.currentTorrentId):system.clearTorrentAttribute()},onLoad:function(){$(this).data("isload")||($(this).data("isload",!0),0!=system.currentTorrentId&&setTimeout((function(){system.getTorrentInfos(system.currentTorrentId)}),500))}}),$.each(this.languages,(function(t,e){$("<option/>").text(e).val(t).attr("selected",t==system.lang.name).appendTo(system.panel.top.find("#lang"))})),this.panel.top.find("#lang").change((function(){location.href="?lang="+this.value})),this.panel.toolbar.attr("class","panel-header"),this.initTree(),this.initToolbar(),this.initStatusBar(),this.initTorrentTable(),this.connect(),this.initEvent(),this.checkUpdate()},initEvent:function(){$(window).resize((function(){$("#main").layout("resize")})),this.panel.droparea[0].addEventListener("dragover",(function(t){t.stopPropagation(),t.preventDefault(),system.debug("#dropArea.dragover")}),!1),this.panel.list[0].addEventListener("dragover",(function(t){t.stopPropagation(),t.preventDefault(),system.panel.droparea.show(),system.debug("dragover")}),!1),this.panel.droparea[0].addEventListener("drop",(function(t){t.stopPropagation(),t.preventDefault(),system.panel.droparea.hide(),system.debug("drop.e.dataTransfer:",t.dataTransfer),system.checkDropFiles(t.dataTransfer.files)}),!1),this.panel.droparea[0].addEventListener("dragleave",(function(t){t.stopPropagation(),t.preventDefault(),system.panel.droparea.hide(),system.debug("dragleave")}),!1),$("#text-drop-title").html(this.lang.public["text-drop-title"]),$("#button-cancel-checked").on("click",(function(){system.control.torrentlist.datagrid("uncheckAll")})),this.panel.left.tree({onExpand:function(t){system.config.ui.status.tree[t.id]=t.state,system.saveConfig()},onCollapse:function(t){system.config.ui.status.tree[t.id]=t.state,system.saveConfig()}}),this.panel.layout_body.layout({onExpand:function(t){system.config.ui.status.layout.body[t]="open",system.saveConfig()},onCollapse:function(t){system.config.ui.status.layout.body[t]="closed",system.saveConfig()}}),this.panel.layout_left.layout({onExpand:function(t){system.config.ui.status.layout.left[t]="open",system.saveConfig()},onCollapse:function(t){system.config.ui.status.layout.left[t]="closed",system.saveConfig()}}),this.panel.main.layout({onExpand:function(t){system.config.ui.status.layout.main[t]="open",system.saveConfig()},onCollapse:function(t){system.config.ui.status.layout.main[t]="closed",system.saveConfig()}})},layoutResize:function(t,e){system.uiIsInitialized&&system.config.ui.status.size[t]&&(system.config.ui.status.size[t]=e,system.saveConfig())},navToolbarClick:function(t){var e=t.id,s=$(t).data("status"),n=null;switch(e){case"tree-toolbar-nav-folders":n=this.panel.left.tree("find","folders"),this.config.foldersShow=1!=s;break;case"tree-toolbar-nav-statistics":n=this.panel.left.tree("find","statistics");break;case"torrent-head-buttons-autoExpandAttribute":(n={}).target=null,this.config.autoExpandAttribute=1!=s}n&&(1==s?($(t).linkbutton({iconCls:"icon-disabled"}),$(n.target).parent().hide(),s=0):($(t).linkbutton({iconCls:"icon-enabled"}),$(n.target).parent().show(),s=1),$(t).data("status",s),this.saveConfig())},checkDropFiles:function(t){if(t&&t.length){for(var e=new Array,s=0;s<t.length;s++){var n=t[s];"torrent"==n.name.split(".").pop().toLowerCase()&&e.push(n)}e.length>0&&system.openDialogFromTemplate({id:"dialog-torrent-addfile",options:{title:system.lang.toolbar["add-torrent"],width:620,height:system.config.nav.labels?500:300,resizable:!0},datas:{files:e}})}},initTree:function(){var t=[{id:"torrent-all",iconCls:"iconfont tr-icon-home",text:this.lang.tree.all+" ("+this.lang.tree.status.loading+")",children:[{id:"downloading",text:this.lang.tree.downloading,iconCls:"iconfont tr-icon-download"},{id:"paused",text:this.lang.tree.paused,iconCls:"iconfont tr-icon-pause2"},{id:"sending",text:this.lang.tree.sending,iconCls:"iconfont tr-icon-upload"},{id:"check",text:this.lang.tree.check,iconCls:"iconfont tr-icon-data-check"},{id:"actively",text:this.lang.tree.actively,iconCls:"iconfont tr-icon-actively"},{id:"error",text:this.lang.tree.error,iconCls:"iconfont tr-icon-errors"},{id:"warning",text:this.lang.tree.warning,iconCls:"iconfont tr-icon-warning"}]}],e={servers:{id:"servers",text:this.lang.tree.servers,state:"closed",iconCls:"iconfont tr-icon-servers",children:[{id:"servers-loading",text:this.lang.tree.status.loading,iconCls:"tree-loading"}]},folders:{id:"folders",text:this.lang.tree.folders,iconCls:"iconfont tr-icon-folder",state:"closed",children:[{id:"folders-loading",text:this.lang.tree.status.loading,iconCls:"tree-loading"}]},statistics:{id:"statistics",text:this.lang.tree.statistics.title,state:"closed",iconCls:"iconfont tr-icon-shuju",children:[{id:"cumulative-stats",text:this.lang.tree.statistics.cumulative,iconCls:"iconfont tr-icon-folder",children:[{id:"uploadedBytes",text:this.lang.tree.statistics.uploadedBytes,iconCls:"iconfont tr-icon-empty"},{id:"downloadedBytes",text:this.lang.tree.statistics.downloadedBytes,iconCls:"iconfont tr-icon-empty"},{id:"filesAdded",text:this.lang.tree.statistics.filesAdded,iconCls:"iconfont tr-icon-empty"},{id:"sessionCount",text:this.lang.tree.statistics.sessionCount,iconCls:"iconfont tr-icon-empty"},{id:"secondsActive",text:this.lang.tree.statistics.secondsActive,iconCls:"iconfont tr-icon-empty"}]},{id:"current-stats",text:this.lang.tree.statistics.current,iconCls:"iconfont tr-icon-folder",children:[{id:"current-uploadedBytes",text:this.lang.tree.statistics.uploadedBytes,iconCls:"iconfont tr-icon-empty"},{id:"current-downloadedBytes",text:this.lang.tree.statistics.downloadedBytes,iconCls:"iconfont tr-icon-empty"},{id:"current-filesAdded",text:this.lang.tree.statistics.filesAdded,iconCls:"iconfont tr-icon-empty"},{id:"current-sessionCount",text:this.lang.tree.statistics.sessionCount,iconCls:"iconfont tr-icon-empty"},{id:"current-secondsActive",text:this.lang.tree.statistics.secondsActive,iconCls:"iconfont tr-icon-empty"}]}]},labels:{id:"labels",text:this.lang.tree.labels,iconCls:"iconfont tr-icon-labels"}};for(var s in this.config.nav){var n=this.config.nav[s],o=e[s];o&&n&&t.push(o)}this.panel.left.tree({data:t,onSelect:function(t){system.loadTorrentToList({node:t})},lines:!0})},initUIStatus:function(){if(!this.uiIsInitialized){system.uiIsInitialized=!0;var t=this.lastUIStatus.tree;for(var e in t){var s;(s=this.panel.left.tree("find",e))&&s.target&&("open"==t[e]?this.panel.left.tree("expand",s.target):this.panel.left.tree("collapse",s.target))}if(this.config.defaultSelectNode)(s=this.panel.left.tree("find",this.config.defaultSelectNode))&&(this.config.foldersShow||-1==this.config.defaultSelectNode.indexOf("folders"))||(s=this.panel.left.tree("find","torrent-all")),this.panel.left.tree("select",s.target);for(var e in this.lastUIStatus.size.nav&&this.lastUIStatus.size.nav.width&&(this.panel.main.layout("panel","west").panel("resize",{width:this.lastUIStatus.size.nav.width+5}),this.panel.main.layout("resize")),this.lastUIStatus.size.attribute&&this.lastUIStatus.size.attribute.height&&(this.panel.layout_body.layout("panel","south").panel("resize",{height:this.lastUIStatus.size.attribute.height}),this.panel.layout_body.layout("resize")),t=this.lastUIStatus.layout.body)"open"==t[e]?this.panel.layout_body.layout("expand",e):this.panel.layout_body.layout("collapse",e);for(var e in t=this.lastUIStatus.layout.left)"open"==t[e]?this.panel.layout_left.layout("expand",e):this.panel.layout_left.layout("collapse",e);for(var e in t=this.lastUIStatus.layout.main)"open"==t[e]?this.panel.main.layout("expand",e):this.panel.main.layout("collapse",e)}},initTorrentTable:function(){this.control.torrentlist=$("<table/>").attr("class","torrent-list").appendTo(this.panel.list);var t=null,e=-1;$.get(system.rootPath+"template/torrent-fields.json?time="+new Date,(function(s){for(var n=s.fields,o={},a=0;a<n.length;a++){o[(i=n[a]).field]=i}for(var r in 0!=system.userConfig.torrentList.fields.length&&(n=$.extend(n,system.userConfig.torrentList.fields)),system.userConfig.torrentList.fields=n,n){var i,l=o[(i=n[r]).field];l&&l.formatter?i.formatter=l.formatter:i.formatter&&delete i.formatter,l&&l.sortable?i.sortable=l.sortable:i.sortable&&delete i.sortable,i.title=system.lang.torrent.fields[i.field]||i.field,system.setFieldFormat(i)}system.control.torrentlist.datagrid({autoRowHeight:!1,pagination:system.config.pagination,rownumbers:!0,remoteSort:!1,checkOnSelect:!1,pageSize:system.config.pageSize,pageList:system.config.pageList,idField:"id",fit:!0,striped:!0,sortName:system.userConfig.torrentList.sortName,sortOrder:system.userConfig.torrentList.sortOrder,drophead:!0,columns:[n],onCheck:function(t,e){system.checkTorrentRow(t,e)},onUncheck:function(t,e){system.checkTorrentRow(t,e)},onCheckAll:function(t){system.checkTorrentRow("all",!1)},onUncheckAll:function(t){system.checkTorrentRow("all",!0)},onSelect:function(t,s){-1!=e&&system.control.torrentlist.datagrid("unselectRow",e),system.getTorrentInfos(s.id),e=t},onUnselect:function(t,s){system.currentTorrentId=0,e=-1},onBeforeLoad:function(t){system.currentTorrentId=0},onSortColumn:function(t,e){var s=t,n=system.control.torrentlist.datagrid("getData").originalRows.sort(arrayObjectSort(s,e));system.control.torrentlist.datagrid("loadData",n),system.resetTorrentListFieldsUserConfig(system.control.torrentlist.datagrid("options").columns[0]),system.userConfig.torrentList.sortName=t,system.userConfig.torrentList.sortOrder=e,system.saveUserConfig()},onRowContextMenu:function(t,e,s){system.config.simpleCheckMode&&system.control.torrentlist.datagrid("uncheckAll"),0==system.checkedRows.length&&system.control.torrentlist.datagrid("checkRow",e),t.preventDefault(),system.showContextMenu("torrent-list",t)},onHeadDrop:function(t,e){system.resetTorrentListFieldsUserConfig(system.control.torrentlist.datagrid("options").columns[0]),system.saveUserConfig()},onResizeColumn:function(t,e){system.resetTorrentListFieldsUserConfig(system.control.torrentlist.datagrid("options").columns[0]),system.saveUserConfig()},onHeaderContextMenu:function(e,s){e.preventDefault(),t||function(){t&&$(t).remove();(t=$("<div/>").appendTo("body")).menu({onClick:function(e){"icon-ok"==e.iconCls?(system.control.torrentlist.datagrid("hideColumn",e.name),t.menu("setIcon",{target:e.target,iconCls:"icon-empty"})):(system.control.torrentlist.datagrid("showColumn",e.name),t.menu("setIcon",{target:e.target,iconCls:"icon-ok"})),system.resetTorrentListFieldsUserConfig(system.control.torrentlist.datagrid("options").columns[0]),system.saveUserConfig()}});for(var e=system.control.torrentlist.datagrid("getColumnFields"),s=0;s<e.length;s++){var n=e[s],o=system.control.torrentlist.datagrid("getColumnOption",n);0!=o.allowCustom&&"false"!=o.allowCustom&&t.menu("appendItem",{text:o.title,name:n,iconCls:o.hidden?"icon-empty":"icon-ok"})}}(),t.menu("show",{left:e.pageX,top:e.pageY})}})}),"json"),this.control.torrentlist.refresh=function(){system.control.torrentlist.datagrid("getPager").find(".pagination-load").click()}},resetTorrentListFieldsUserConfig:function(t){var e={};$.each(this.userConfig.torrentList.fields,(function(t,s){e[s.field]=s})),this.userConfig.torrentList.fields=[],$.each(t,(function(t,s){var n=$.extend({},e[s.field]);n.width=s.width,n.hidden=s.hidden,system.userConfig.torrentList.fields.push(n)}))},showContextMenu:function(t,e){var s=this.contextMenus[t];s?s.empty():(s=$("<div/>").attr("class","easyui-menu").css({"min-width":"180px"}).appendTo(this.panel.main),this.contextMenus[t]=s,s.menu());var n=null;switch(t){case"torrent-list":n=new Array("start","pause","-","rename","remove","recheck","-","morepeers","changeDownloadDir","copyPath","-","menu-queue-move-top","menu-queue-move-up","menu-queue-move-down","menu-queue-move-bottom","magnetLink"),this.config.nav.labels&&(n.push("-"),n.push("setLabels"));var o=this.panel.toolbar;for(var a in n){var r=n[a];if("-"==r)$("<div class='menu-sep'></div>").appendTo(s);else{var i=o.find("#toolbar_"+r);i.length>0?s.menu("appendItem",{text:i.attr("title"),id:r,iconCls:i.linkbutton("options").iconCls,disabled:i.linkbutton("options").disabled,onclick:function(){system.panel.toolbar.find("#toolbar_"+$(this).attr("id")).click()}}):(i=$("#"+r)).length>0?s.menu("appendItem",{text:i.attr("title"),id:r,iconCls:i.attr("id").replace("menu-queue-move","iconfont tr-icon"),disabled:o.find("#toolbar_queue").linkbutton("options").disabled,onclick:function(){$("#"+$(this).attr("id")).click()}}):(i=this.getContentMenuWithKey(r,s))&&s.menu("appendItem",i),i=null}}var l=$("#copyPath",s);l.attr({"data-clipboard-action":"copy","data-clipboard-target":"#clipboard-source"});new ClipboardJS(l.get(0))}s.menu("show",{left:e.pageX,top:e.pageY,hideOnUnhover:!1}),s=null,n=null},getContentMenuWithKey:function(t,e){switch(t){case"setLabels":return{id:"setLabels",text:system.lang.menus.setLabels,iconCls:"iconfont tr-icon-labels",disabled:0==this.checkedRows.length,onclick:function(){var t=system.checkedRows,e=new Array;for(var s in t)e.push(t[s].hashString);0!=e.length&&system.openDialogFromTemplate({id:"dialog-torrent-setLabels",options:{title:system.lang.dialog["torrent-setLabels"].title,width:520,height:200},datas:{hashs:e}})}};case"magnetLink":return{id:"magnetLink",text:system.lang.menus.copyMagnetLink,iconCls:"iconfont tr-icon-labels",disabled:0==this.checkedRows.length,onclick:function(){system.getTorrentMagnetLink((function(t){system.copyToClipboard(t),e.css("display","block")}))}}}},formetTorrentLabels:function(t,e){var s=$("<div style='position: relative;'/>");if(t){"string"==typeof t&&(t=t.split(","));for(var n=0;n<t.length;n++){var o=t[n],a=this.config.labels[o];a&&$("<span class='user-label'/>").html(a.name).css({"background-color":a.color,color:getGrayLevel(a.color)>.5?"#000":"#fff"}).appendTo(s)}}var r=$("<button onclick='javascript:system.setTorrentLabels(this,\""+e+'");\' data-options="iconCls:\'iconfont tr-icon-labels\',plain:true" class="easyui-linkbutton user-label-set"/>').appendTo(s);return r.linkbutton(),r.find("span").first().attr({title:system.lang.dialog["torrent-setLabels"].title}),s.get(0).outerHTML},setTorrentLabels:function(t,e){system.openDialogFromTemplate({id:"dialog-torrent-setLabels",options:{title:system.lang.dialog["torrent-setLabels"].title,width:520,height:200},datas:{hashs:[e]},type:1,source:$(t)})},checkTorrentRow:function(t,e){if(this.checkedRows=this.control.torrentlist.datagrid("getChecked"),this.showCheckedInStatus(),"all"==t){if(0==this.control.torrentlist.datagrid("getRows").length)return;return $("#toolbar_start, #toolbar_pause, #toolbar_remove, #toolbar_recheck, #toolbar_changeDownloadDir,#toolbar_morepeers,#toolbar_copyPath",this.panel.toolbar).linkbutton({disabled:e}),$("#toolbar_rename, #toolbar_morepeers",this.panel.toolbar).linkbutton({disabled:!0}),void this.panel.toolbar.find("#toolbar_queue").menubutton("disable")}if(0==this.checkedRows.length)return $("#toolbar_start, #toolbar_pause, #toolbar_rename, #toolbar_remove, #toolbar_recheck, #toolbar_changeDownloadDir,#toolbar_morepeers,#toolbar_copyPath",this.panel.toolbar).linkbutton({disabled:!0}),void this.panel.toolbar.find("#toolbar_queue").menubutton("disable");if(1==this.checkedRows.length)switch($("#toolbar_remove, #toolbar_rename, #toolbar_changeDownloadDir,#toolbar_copyPath",this.panel.toolbar).linkbutton({disabled:!1}),this.panel.toolbar.find("#toolbar_queue").menubutton("enable"),transmission.torrents.all[e.id].status){case transmission._status.stopped:this.panel.toolbar.find("#toolbar_start, #toolbar_recheck").linkbutton({disabled:!1}),this.panel.toolbar.find("#toolbar_pause, #toolbar_morepeers").linkbutton({disabled:!0});break;case transmission._status.check:case transmission._status.checkwait:this.panel.toolbar.find("#toolbar_start, #toolbar_pause, #toolbar_recheck, #toolbar_morepeers").linkbutton({disabled:!0});break;default:this.panel.toolbar.find("#toolbar_start, #toolbar_recheck").linkbutton({disabled:!0}),this.panel.toolbar.find("#toolbar_pause, #toolbar_morepeers").linkbutton({disabled:!1})}else $("#toolbar_start, #toolbar_pause, #toolbar_remove, #toolbar_recheck, #toolbar_changeDownloadDir,#toolbar_copyPath",this.panel.toolbar).linkbutton({disabled:!1}),$("#toolbar_rename, #toolbar_morepeers",this.panel.toolbar).linkbutton({disabled:!0}),this.panel.toolbar.find("#toolbar_queue").menubutton("disable")},showCheckedInStatus:function(){if(this.checkedRows.length>0){this.panel.status_text.empty(),this.showStatus(void 0,0);var t=[],e=this.lang.system.status.checked.replace("%n",this.checkedRows.length),s=[];$("<div style='padding: 5px;'/>").html(e).appendTo(this.panel.status_text);for(var n=0;n<this.checkedRows.length;n++){var o=this.checkedRows[n];t.push({value:n,text:n+1+". "+o.name}),-1===$.inArray(o.downloadDir,s)&&s.push(o.downloadDir)}$("<div/>").appendTo(this.panel.status_text).datalist({data:t}),$(".datalist>.panel-body",this.panel.status_text).css({border:0}),$("#button-cancel-checked").show(),$("#clipboard-source").val(s.join("\n"))}else $("#button-cancel-checked").hide(),this.panel.status_text.empty(),$("#clipboard-source").val("")},copyToClipboard:function(t){var e="copy_to_clipboard_textarea",s=document.getElementById(e);s||(s=document.createElement("textarea")),s.id=e,s.style.display="block",s.value=t,document.body.appendChild(s),s.select(),document.execCommand("copy"),s.style.display="none"},initToolbar:function(){this.panel.toolbar.find("#toolbar_label_reload_time").html(this.lang.toolbar["reload-time"]),this.panel.toolbar.find("#toolbar_label_reload_time_unit").html(this.lang.toolbar["reload-time-unit"]),this.panel.toolbar.find("#toolbar_reload_time").numberspinner({value:this.config.reloadStep/1e3,min:3,disabled:!this.config.autoReload,onChange:function(){var t=this.value;$.isNumeric(t)&&(system.config.reloadStep=1e3*t,system.saveConfig())}}),this.panel.toolbar.find("#toolbar_autoreload").linkbutton({text:this.config.autoReload?this.lang.toolbar["autoreload-enabled"]:this.lang.toolbar["autoreload-disabled"],iconCls:this.config.autoReload?"icon-enabled":"icon-disabled"}).attr("title",this.config.autoReload?this.lang.toolbar.tip["autoreload-disabled"]:this.lang.toolbar.tip["autoreload-enabled"]).click((function(){system.config.autoReload?(system.config.autoReload=!1,clearTimeout(system.autoReloadTimer),system.panel.toolbar.find("#toolbar_reload_time").numberspinner("disable")):(system.config.autoReload=!0,system.reloadData(),system.panel.toolbar.find("#toolbar_reload_time").numberspinner("enable")),system.saveConfig(),$(this).linkbutton({text:system.config.autoReload?system.lang.toolbar["autoreload-enabled"]:system.lang.toolbar["autoreload-disabled"],iconCls:system.config.autoReload?"icon-enabled":"icon-disabled"}).attr("title",system.config.autoReload?system.lang.toolbar.tip["autoreload-disabled"]:system.lang.toolbar.tip["autoreload-enabled"])})),this.panel.toolbar.find("#toolbar_add_torrents").linkbutton({text:this.lang.toolbar["add-torrent"],disabled:!1}).attr("title",this.lang.toolbar.tip["add-torrent"]).click((function(){system.openDialogFromTemplate({id:"dialog-torrent-add",options:{title:system.lang.toolbar["add-torrent"],width:620,height:system.config.nav.labels?600:400,resizable:!0}})})),this.panel.toolbar.find("#toolbar_start_all").linkbutton({disabled:!1}).attr("title",this.lang.toolbar.tip["start-all"]).click((function(){var t=$(this),e=t.linkbutton("options").iconCls;t.linkbutton({disabled:!0,iconCls:"icon-loading"}),transmission.exec({method:"torrent-start"},(function(s){t.linkbutton({iconCls:e,disabled:!1}),t=null}))})),this.panel.toolbar.find("#toolbar_pause_all").linkbutton({disabled:!1}).attr("title",this.lang.toolbar.tip["pause-all"]).click((function(){var t=$(this),e=t.linkbutton("options").iconCls;t.linkbutton({disabled:!0,iconCls:"icon-loading"}),transmission.exec({method:"torrent-stop"},(function(s){t.linkbutton({iconCls:e,disabled:!1}),t=null}))})),this.panel.toolbar.find("#toolbar_start").linkbutton({disabled:!0}).attr("title",this.lang.toolbar.tip.start).click((function(){system.changeSelectedTorrentStatus("start",$(this))})),this.panel.toolbar.find("#toolbar_pause").linkbutton({disabled:!0}).attr("title",this.lang.toolbar.tip.pause).click((function(){system.changeSelectedTorrentStatus("stop",$(this))})),this.panel.toolbar.find("#toolbar_recheck").linkbutton({disabled:!0}).attr("title",this.lang.toolbar.tip.recheck).click((function(){var t=system.control.torrentlist.datagrid("getChecked");t.length>0&&(1==t.length?transmission.torrents.all[t[0].id].percentDone>0?confirm(system.lang.toolbar.tip["recheck-confirm"])&&system.changeSelectedTorrentStatus("verify",$(this)):system.changeSelectedTorrentStatus("verify",$(this)):confirm(system.lang.toolbar.tip["recheck-confirm"])&&system.changeSelectedTorrentStatus("verify",$(this)))})),this.panel.toolbar.find("#toolbar_morepeers").linkbutton({disabled:!0}).click((function(){system.changeSelectedTorrentStatus("reannounce",$(this))})),this.panel.toolbar.find("#toolbar_remove").linkbutton({disabled:!0}).attr("title",this.lang.toolbar.tip.remove).click((function(){var t=system.control.torrentlist.datagrid("getChecked"),e=new Array;for(var s in t)e.push(t[s].id);0!=e.length&&system.openDialogFromTemplate({id:"dialog-torrent-remove-confirm",options:{title:system.lang.dialog["torrent-remove"].title,width:350,height:150},datas:{ids:e}})})),this.panel.toolbar.find("#toolbar_rename").linkbutton({disabled:!0}).click((function(){var t=system.control.torrentlist.datagrid("getChecked");0!=t.length&&system.openDialogFromTemplate({id:"dialog-torrent-rename",options:{title:system.lang.dialog["torrent-rename"].title,width:520,height:200,resizable:!0},datas:{id:t[0].id}})})),this.panel.toolbar.find("#toolbar_changeDownloadDir").linkbutton({disabled:!0}).attr("title",this.lang.toolbar.tip["change-download-dir"]).click((function(){var t=system.control.torrentlist.datagrid("getChecked"),e=new Array;for(var s in t)e.push(t[s].id);0!=e.length&&system.openDialogFromTemplate({id:"dialog-torrent-changeDownloadDir",options:{title:system.lang.dialog["torrent-changeDownloadDir"].title,width:520,height:200},datas:{ids:e}})})),this.panel.toolbar.find("#toolbar_alt_speed").linkbutton().attr("title",this.lang.toolbar.tip["alt-speed"]).click((function(){var t=$(this),e=t.linkbutton("options"),s=!1;"iconfont tr-icon-rocket"==e.iconCls&&(s=!0),transmission.exec({method:"session-set",arguments:{"alt-speed-enabled":s}},(function(e){"success"==e.result&&(system.serverConfig["alt-speed-enabled"]=s,t.linkbutton({iconCls:"iconfont tr-icon-"+(s?"woniu":"rocket")}),s?$("#status_alt_speed").show():$("#status_alt_speed").hide())})),t.linkbutton({iconCls:"icon-loading"})})),this.panel.toolbar.find("#toolbar_config").linkbutton().attr("title",this.lang.toolbar.tip["system-config"]).click((function(){system.openDialogFromTemplate({id:"dialog-system-config",options:{title:system.lang.toolbar["system-config"],width:680,height:500,resizable:!0}})})),this.panel.toolbar.find("#toolbar_reload").linkbutton().attr("title",this.lang.toolbar.tip["system-reload"]).click((function(){system.reloadData()})),this.panel.toolbar.find("#toolbar_search").searchbox({searcher:function(t){system.searchTorrents(t)},prompt:this.lang.toolbar["search-prompt"]}),this.panel.toolbar.find("#toolbar_copyPath").linkbutton().attr("title",this.lang.toolbar.tip["copy-path-to-clipboard"])},initStatusBar:function(){this.panel.statusbar.find("#status_title_downloadspeed").html(this.lang.statusbar.downloadspeed),this.panel.statusbar.find("#status_title_uploadspeed").html(this.lang.statusbar.uploadspeed)},connect:function(){this.showStatus(this.lang.system.status.connect,0),transmission.on.torrentCountChange=function(){system.reloadTorrentBaseInfos()},transmission.on.postError=function(){},transmission.init({islocal:!0},(function(){system.reloadSession(!0),system.getServerStatus()}))},reloadSession:function(t){transmission.getSession((function(e){system.serverConfig=e,$("#status_version").html("Transmission "+system.lang.statusbar.version+e.version+", RPC: "+e["rpc-version"]+", WEB Control: "+system.version+"("+system.codeupdate+")"),1==e["alt-speed-enabled"]?(system.panel.toolbar.find("#toolbar_alt_speed").linkbutton({iconCls:"iconfont tr-icon-woniu"}),$("#status_alt_speed").show()):(system.panel.toolbar.find("#toolbar_alt_speed").linkbutton({iconCls:"iconfont tr-icon-rocket"}),$("#status_alt_speed").hide()),system.downloadDir=e["download-dir"],0==transmission.downloadDirs.length&&transmission.downloadDirs.push(system.downloadDir),parseInt(system.serverConfig["rpc-version"])>=15?transmission.getFreeSpace(system.downloadDir,(function(t){system.serverConfig["download-dir-free-space"]=t.arguments["size-bytes"],system.showFreeSpace(t.arguments["size-bytes"])})):system.showFreeSpace(system.serverConfig["download-dir-free-space"]),t&&system.showStatus(system.lang.system.status.connected)}))},showFreeSpace:function(t){var e=t;e=-1==e?system.lang.public["text-unknown"]:formatSize(e),$("#status_freespace").text(system.lang.dialog["system-config"]["download-dir-free-space"]+" "+e)},reloadTorrentBaseInfos:function(t,e){if(!this.reloading){clearTimeout(this.autoReloadTimer),this.reloading=!0;var s={trackers:transmission.trackers,folders:transmission.torrents.folders};transmission.torrents.getallids((function(t){var e=new Array;for(var n in t){var o=t[n];e.push(o.id)}var a=transmission.torrents.getErrorIds(e,!0);a.length>0?transmission.torrents.getallids((function(){system.resetTorrentInfos(s)}),a):system.resetTorrentInfos(s)}),t,e)}},resetTorrentInfos:function(t){this.resetNavTorrentStatus(),this.resetNavServers(t),this.resetNavStatistics(),this.resetNavFolders(t),this.resetNavLabels(),"Firefox"==$.ua.browser.name&&$.ua.browser.major<60&&system.panel.left.find("span.nav-total-size").css({"margin-top":"-19px"})},resetNavTorrentStatus:function(){var t=this.currentTorrentId;if(transmission.torrents.status[transmission._status.stopped]?system.updateTreeNodeText("paused",system.lang.tree.paused+this.showNodeMoreInfos(transmission.torrents.status[transmission._status.stopped].length)):system.updateTreeNodeText("paused",system.lang.tree.paused),transmission.torrents.status[transmission._status.seed]?system.updateTreeNodeText("sending",system.lang.tree.sending+this.showNodeMoreInfos(transmission.torrents.status[transmission._status.seed].length)):system.updateTreeNodeText("sending",system.lang.tree.sending),transmission.torrents.status[transmission._status.seedwait]){var e=system.panel.left.tree("find","sending"),s=system.panel.left.tree("getChildren",e.target),n=system.lang.tree.wait+this.showNodeMoreInfos(transmission.torrents.status[transmission._status.seedwait].length);s.length>0?system.updateTreeNodeText(s[0].id,n):system.appendTreeNode(e,[{id:"seedwait",text:n,iconCls:"iconfont tr-icon-wait"}])}else system.removeTreeNode("seedwait");if(transmission.torrents.status[transmission._status.check]?system.updateTreeNodeText("check",system.lang.tree.check+this.showNodeMoreInfos(transmission.torrents.status[transmission._status.check].length)):system.updateTreeNodeText("check",system.lang.tree.check),transmission.torrents.status[transmission._status.checkwait]){var e=system.panel.left.tree("find","check");s=system.panel.left.tree("getChildren",e.target),n=system.lang.tree.wait+this.showNodeMoreInfos(transmission.torrents.status[transmission._status.checkwait].length);s.length>0?system.updateTreeNodeText(s[0].id,n):system.appendTreeNode(e,[{id:"checkwait",text:n,iconCls:"iconfont tr-icon-wait"}])}else system.removeTreeNode("checkwait");if(transmission.torrents.status[transmission._status.download]?system.updateTreeNodeText("downloading",system.lang.tree.downloading+this.showNodeMoreInfos(transmission.torrents.status[transmission._status.download].length)):system.updateTreeNodeText("downloading",system.lang.tree.downloading),transmission.torrents.status[transmission._status.downloadwait]){e=system.panel.left.tree("find","downloading"),s=system.panel.left.tree("getChildren",e.target),n=system.lang.tree.wait+this.showNodeMoreInfos(transmission.torrents.status[transmission._status.downloadwait].length);s.length>0?system.updateTreeNodeText(s[0].id,n):system.appendTreeNode(e,[{id:"downloadwait",text:n,iconCls:"iconfont tr-icon-wait"}])}else system.removeTreeNode("downloadwait");if(system.updateTreeNodeText("actively",system.lang.tree.actively+this.showNodeMoreInfos(transmission.torrents.actively.length)),system.updateTreeNodeText("error",system.lang.tree.error+this.showNodeMoreInfos(transmission.torrents.error.length)),system.updateTreeNodeText("warning",system.lang.tree.warning+this.showNodeMoreInfos(transmission.torrents.warning.length)),null!=(e=system.panel.left.tree("getSelected"))){var o=system.control.torrentlist.datagrid("options").pageNumber;system.loadTorrentToList({node:e,page:o})}0!=t&&system.control.torrentlist.datagrid("selectRecord",t),system.reloading=!1,system.config.autoReload&&(system.autoReloadTimer=setTimeout((function(){system.reloadData()}),system.config.reloadStep)),system.updateTreeNodeText("torrent-all",system.lang.tree.all+this.showNodeMoreInfos(transmission.torrents.count,transmission.torrents.totalSize))},resetNavServers:function(t){var e=this.panel.left.tree("find","servers");if(this.config.nav.servers){if(e){var s=e.state;this.removeTreeNode("servers-loading")}else this.appendTreeNode(null,[{id:"servers",text:this.lang.tree.servers,state:"closed",iconCls:"iconfont tr-icon-servers"}]),e=this.panel.left.tree("find","servers");new Array;var n=this.panel.left.tree("find","btservers"),o=n?n.state:"close";for(var a in!n&&system.config.showBTServers&&(this.appendTreeNode(e,[{id:"btservers",text:"BT",state:"open",iconCls:"iconfont tr-icon-bt"}]),n=this.panel.left.tree("find","btservers")),transmission.trackers){if(!(l=transmission.trackers[a]).isBT||system.config.showBTServers){var r=system.panel.left.tree("find",l.nodeid),i=l.name+this.showNodeMoreInfos(l.count,l.size);r?system.updateTreeNodeText(l.nodeid,i,l.connected?"iconfont tr-icon-server":"iconfont tr-icon-server-error"):system.appendTreeNode(l.isBT?n:e,[{id:l.nodeid,text:i,iconCls:l.connected?"iconfont tr-icon-server":"iconfont tr-icon-server-error"}]),t.trackers[l.nodeid]=null}}for(var a in"closed"==s&&this.panel.left.tree("collapse",e.target),system.config.showBTServers&&n&&"closed"==o&&this.panel.left.tree("collapse",n.target),t.trackers){var l;(l=t.trackers[a])&&system.removeTreeNode(l.nodeid)}}else e&&this.panel.left.tree("remove",e.target)},resetNavStatistics:function(){if(this.config.nav.statistics){var t="uploadedBytes,downloadedBytes,filesAdded,sessionCount,secondsActive".split(",");$.each(t,(function(t,e){switch(e){case"uploadedBytes":case"downloadedBytes":system.updateTreeNodeText(e,system.lang.tree.statistics[e]+" "+formatSize(system.serverSessionStats["cumulative-stats"][e])),system.updateTreeNodeText("current-"+e,system.lang.tree.statistics[e]+" "+formatSize(system.serverSessionStats["current-stats"][e]));break;case"secondsActive":system.updateTreeNodeText(e,system.lang.tree.statistics[e]+" "+getTotalTime(1e3*system.serverSessionStats["cumulative-stats"][e])),system.updateTreeNodeText("current-"+e,system.lang.tree.statistics[e]+" "+getTotalTime(1e3*system.serverSessionStats["current-stats"][e]));break;default:system.updateTreeNodeText(e,system.lang.tree.statistics[e]+" "+system.serverSessionStats["cumulative-stats"][e]),system.updateTreeNodeText("current-"+e,system.lang.tree.statistics[e]+" "+system.serverSessionStats["current-stats"][e])}}))}else{var e=this.panel.left.tree("find","statistics");e&&this.panel.left.tree("remove",e.target)}},resetNavFolders:function(t){if(this.config.nav.folders){for(var e in transmission.torrents.folders){var s=transmission.torrents.folders[e];t.folders[s.nodeid]=null}this.loadFolderList(t.folders)}else{this.initUIStatus();var n=this.panel.left.tree("find","folders");n&&this.panel.left.tree("remove",n.target)}},resetNavLabels:function(t){if(this.config.nav.labels){if(t)for(var e=this.panel.left.tree("getChildren",this.panel.left.tree("find","labels").target),s=0;s<e.length;s++)this.panel.left.tree("remove",e[s].target);for(s=0;s<this.config.labels.length;s++){var n=this.config.labels[s],o="label-"+this.getValidTreeKey(n.name);(a=this.panel.left.tree("find",o))||(this.appendTreeNode("labels",[{id:o,text:n.name,labelIndex:s,iconCls:"iconfont tr-icon-label"}]),a=this.panel.left.tree("find",o),$(".tree-icon",a.target).css({color:n.color}),$(".tree-title",a.target).addClass("user-label").css({"background-color":n.color,color:getGrayLevel(n.color)>.5?"#000":"#fff"}))}}else{var a;(a=this.panel.left.tree("find","labels"))&&this.panel.left.tree("remove",a.target)}},showNodeMoreInfos:function(t,e){var s="";return t>0&&(s=" <span class='nav-torrents-number'>("+t+")</span>"),e>0&&(s+="<span class='nav-total-size'>["+formatSize(e)+"]</span>"),s},getServerStatus:function(){this.reloading||(clearTimeout(this.autoReloadTimer),this.reloading=!0,transmission.getStatus((function(t){if(system.reloading=!1,$("#status_downloadspeed").html(formatSize(t.downloadSpeed,!1,"speed")),$("#status_uploadspeed").html(formatSize(t.uploadSpeed,!1,"speed")),system.serverSessionStats=t,0==t.torrentCount){var e=system.panel.left.tree("find","servers");e&&system.panel.left.tree("remove",e.target),system.updateTreeNodeText("torrent-all",system.lang.tree.all)}})))},showStatus:function(t,e){$("#m_status").panel("options").collapsed&&$("#layout_left").layout("expand","south"),this.panel.status_text.show(),t&&this.panel.status_text.html(t),0!=e&&(null==e&&(e=3e3),this.panel.status_text.fadeOut(e,(function(){$("#layout_left").layout("collapse","south")})))},updateTreeNodeText:function(t,e,s){var n=this.panel.left.tree("find",t);if(n){var o={target:n.target,text:e};null!=s&&(o.iconCls=s),this.panel.left.tree("update",o)}n=null},appendTreeNode:function(t,e){var s=null;(s="string"==typeof t?this.panel.left.tree("find",t):t)?this.panel.left.tree("append",{parent:s.target,data:e}):this.panel.left.tree("append",{data:e}),s=null},removeTreeNode:function(t){var e=this.panel.left.tree("find",t);e&&this.panel.left.tree("remove",e.target),e=null},loadTorrentToList:function(t){if(transmission.torrents.all){if(jQuery.extend({node:null,page:1},t),t.node){var e=null,s=this.panel.left.tree("getParent",t.node.target)||{id:""},n=this.panel.left.data("currentNodeId");switch(n!=t.node.id&&(this.control.torrentlist.datagrid("uncheckAll"),this.control.torrentlist.datagrid({pageNumber:1}),n=t.node.id),this.panel.left.data("currentNodeId",n),s.id){case"servers":case"btservers":e="btservers"==t.node.id?transmission.torrents.btItems:transmission.trackers[t.node.id].torrents;break;default:switch(t.node.id){case"torrent-all":case"servers":e=transmission.torrents.all;break;case"paused":e=transmission.torrents.status[transmission._status.stopped];break;case"sending":e=transmission.torrents.status[transmission._status.seed];break;case"seedwait":e=transmission.torrents.status[transmission._status.seedwait];break;case"check":e=transmission.torrents.status[transmission._status.check];break;case"checkwait":e=transmission.torrents.status[transmission._status.checkwait];break;case"downloading":e=transmission.torrents.status[transmission._status.download];break;case"downloadwait":e=transmission.torrents.status[transmission._status.downloadwait];break;case"actively":e=transmission.torrents.actively;break;case"error":e=transmission.torrents.error;break;case"warning":e=transmission.torrents.warning;break;case"search-result":e=transmission.torrents.searchResult;break;case"btservers":e=transmission.torrents.btItems;break;default:if(-1!=t.node.id.indexOf("folders-")){var o=transmission.torrents.folders[t.node.id];if(o)if(this.config.hideSubfolders){e=[];for(var a=0;a<o.torrents.length;a++){var r=o.torrents[a];r.downloadDir.replace(/[\\|\/]/g,"")==t.node.path&&e.push(r)}}else e=o.torrents}else if(-1!=t.node.id.indexOf("label-")){var i=parseInt(t.node.labelIndex);for(var l in e=[],transmission.torrents.all){var d=transmission.torrents.all[l];(h=this.config.labelMaps[d.hashString])&&-1!=$.inArray(i,h)&&e.push(d)}}}}this.config.defaultSelectNode!=t.node.id&&(this.control.torrentlist.datagrid("loadData",[]),this.config.defaultSelectNode=t.node.id,this.saveConfig());var c=new Array;for(var a in e){if(!e[a])return;var u=this.lang.torrent["status-text"][e[a].status];parseFloat(100*e[a].percentDone).toFixed(2);u==transmission._status.check&&parseFloat(100*e[a].recheckProgress).toFixed(2),0!=e[a].error?u="<span class='text-status-error'>"+u+"</span>":e[a].warning&&(u="<span class='text-status-warning' title='"+e[a].warning+"'>"+u+"</span>");var h,m={};(m=$.extend(m,e[a])).status=u,m.statusCode=e[a].status,m.completeSize=Math.max(0,e[a].totalSize-e[a].leftUntilDone),m.leecherCount=e[a].leecher,m.seederCount=e[a].seeder,(h=this.config.labelMaps[m.hashString])&&(m.labels=h),c.push(m)}this.updateTorrentCurrentPageDatas(c),this.initShiftCheck()}}},initShiftCheck:function(){var t=$("#m_list div.datagrid-cell-check input:checkbox");t.off("click.Shift");var e=null,s=this.control.torrentlist;t.on("click.Shift",(function(n){if(e){if(n.shiftKey)for(var o=t.index(this),a=t.index(e),r=e.checked,i=Math.min(o,a),l=Math.max(o,a)+1,d=i;d<l;d++)r?s.datagrid("checkRow",d):s.datagrid("uncheckRow",d);e=this}else e=this}))},updateTorrentCurrentPageDatas:function(t){var e=this.control.torrentlist.datagrid("getRows");if(0==t.length&&e.length>0)this.control.torrentlist.datagrid("loadData",[]);else{var s=this.control.torrentlist.datagrid("options"),n=null;if(s.sortName){var o=n=s.sortName;t=t.sort(arrayObjectSort(o,s.sortOrder))}if(0==e.length||t.length!=this.control.torrentlist.datagrid("getData").total&&t.length>s.pageSize)this.control.torrentlist.datagrid({loadFilter:pagerFilter,pageNumber:s.pageNumber,sortName:n,sortOrder:s.sortOrder}).datagrid("loadData",t);else{this.control.torrentlist.datagrid("getData").originalRows=t;var a=(s.pageNumber-1)*parseInt(s.pageSize),r=a+parseInt(s.pageSize);t=t.slice(a,r);var i={},l={};for(var d in transmission.torrents.recently){i[(h=transmission.torrents.recently[d]).id]=!0,h=null}for(var d in t){l[(h=t[d]).id]=h,h=null}var c={};for(d=e.length-1;d>=0;d--){var u=l[(h=e[d]).id];u?i[h.id]?(this.control.torrentlist.datagrid("updateRow",{index:d,row:u}),c[h.id]=h):transmission.torrents.removed&&transmission.torrents.removed.length>0&&-1!=$.inArray(h.id,transmission.torrents.removed)?this.control.torrentlist.datagrid("deleteRow",d):c[h.id]=h:this.control.torrentlist.datagrid("deleteRow",d),h=null,u=null}for(var d in t){var h;c[(h=t[d]).id]||this.control.torrentlist.datagrid("appendRow",h)}e=null,i=null,l=null}}},getTorrentNameBar:function(t){var e="",s=t.name;switch(t.status){case transmission._status.stopped:e="iconlabel icon-pause-small";break;case transmission._status.check:e="iconlabel icon-checking";break;case transmission._status.download:e="iconlabel icon-down";break;case transmission._status.seed:e="iconlabel icon-up";break;case transmission._status.seedwait:case transmission._status.downloadwait:case transmission._status.checkwait:e="iconlabel icon-wait"}return s+="\n"+t.downloadDir,t.warning&&(e="iconlabel icon-warning-type1",s+="\n\n"+this.lang.public["text-info"]+": "+t.warning),0!=t.error&&(e="iconlabel icon-exclamation",s+="\n\n"+this.lang.public["text-info"]+": "+t.errorString),'<span class="'+e+'" title="'+s+'">'+t.name+"</span>"},getTorrentProgressBar:function(t,e){t+="%";var s="";switch("object"==typeof e?e.status:e){case transmission._status.stopped:s="torrent-progress-stop";break;case transmission._status.checkwait:case transmission._status.check:s="torrent-progress-check";break;case transmission._status.downloadwait:case transmission._status.download:s="torrent-progress-download";break;case transmission._status.seedwait:case transmission._status.seed:s="torrent-progress-seed"}return"object"==typeof e&&(e.warning&&(s="torrent-progress-warning"),0!=e.error&&(s="torrent-progress-error")),'<div class="torrent-progress" title="'+t+'"><div class="torrent-progress-text">'+t+'</div><div class="torrent-progress-bar '+s+'" style="width:'+t+';"></div></div>'},addTorrentsToServer:function(t,e,s,n,o){var a=e-t.length,r=t.shift();if(!r)return this.showStatus(this.lang.system.status.queuefinish),this.getServerStatus(),void(null!=o&&system.saveConfig());this.showStatus(this.lang.system.status.queue+(a+1)+"/"+e+"<br/>"+r,0),transmission.addTorrentFromUrl(r,n,s,(function(a){system.addTorrentsToServer(t,e,s,n,o),null!=o&&null!=a.hashString&&system.saveLabelsConfig(a.hashString,o)}))},changeSelectedTorrentStatus:function(t,e,s){var n=this.control.torrentlist.datagrid("getChecked"),o=new Array;for(var a in t||(t="start"),n)o.push(n[a].id);if(s||(s="torrent-"+t),o.length>0){if(e){var r=e.linkbutton("options").iconCls;e.linkbutton({disabled:!0,iconCls:"icon-loading"})}transmission.exec({method:s,arguments:{ids:o}},(function(t){e&&e.linkbutton({iconCls:r}),system.control.torrentlist.datagrid("uncheckAll"),system.reloadTorrentBaseInfos()}))}},getTorrentMagnetLink:function(t){var e=this.control.torrentlist.datagrid("getChecked"),s=new Array;for(var n in e)s.push(e[n].id);transmission.torrents.getMagnetLink(s,t)},searchTorrents:function(t){if(""!=t){var e=transmission.torrents.search(t);if(null!=e&&0!=e.length){var s=this.panel.left.tree("find","search-result"),n=this.lang.tree["search-result"]+" : "+t+" ("+e.length+")";null==s?(this.appendTreeNode("torrent-all",[{id:"search-result",text:n,iconCls:"iconfont tr-icon-search"}]),s=this.panel.left.tree("find","search-result")):this.panel.left.tree("update",{target:s.target,text:n}),this.panel.left.tree("select",s.target)}else this.removeTreeNode("search-result")}},getTorrentInfos:function(t){if(transmission.torrents.all[t]&&!transmission.torrents.all[t].infoIsLoading&&!(this.currentTorrentId>0&&transmission.torrents.all[this.currentTorrentId]&&transmission.torrents.all[this.currentTorrentId].infoIsLoading||(this.currentTorrentId=t,this.panel.attribute.panel("options").collapsed))){var e=transmission.torrents.all[t];e.infoIsLoading=!0;var s="fileStats,trackerStats,peers,leftUntilDone,status,rateDownload,rateUpload,uploadedEver,uploadRatio,error,errorString,pieces,pieceCount,pieceSize";e.moreInfosTag||(s+=",files,trackers,comment,dateCreated,creator,downloadDir"),transmission.torrents.getMoreInfos(s,t,(function(s){e.infoIsLoading=!1,null!=s&&(jQuery.extend(e,s[0]),0!=system.currentTorrentId&&system.currentTorrentId==t?(e.completeSize=e.totalSize-e.leftUntilDone,e.moreInfosTag=!0,system.fillTorrentBaseInfos(e),system.fillTorrentFileList(e),system.fillTorrentServerList(e),system.fillTorrentPeersList(e),system.fillTorrentConfig(e),transmission.torrents.all[t]=e,transmission.torrents.datas[t]=e):system.clearTorrentAttribute())}))}},clearTorrentAttribute:function(){system.panel.attribute.find("#torrent-files-table").datagrid("loadData",[]),system.panel.attribute.find("#torrent-servers-table").datagrid("loadData",[]),system.panel.attribute.find("#torrent-peers-table").datagrid("loadData",[]),system.panel.attribute.find("span[id*='torrent-attribute-value']").html("")},updateCurrentPageDatas:function(t,e,s){var n=s.datagrid("getRows"),o=s.datagrid("options"),a=null;if(o.sortName&&(a=o.sortName,e=e.sort(arrayObjectSort(a,o.sortOrder))),0!=n.length&&e.length==s.datagrid("getData").total){s.datagrid("getData").originalRows=e;var r=(o.pageNumber-1)*parseInt(o.pageSize),i=r+parseInt(o.pageSize);e=e.slice(r,i);var l={};for(var d in e){l[(c=e[d])[t]]=c,c=null}for(d=n.length-1;d>=0;d--){var c,u=l[(c=n[d])[t]];u?s.datagrid("updateRow",{index:d,row:u}):s.datagrid("deleteRow",d),u=null,c=null}}else s.datagrid({loadFilter:pagerFilter,pageNumber:1,sortName:a,sortOrder:o.sortOrder}).datagrid("loadData",e)},fillTorrentBaseInfos:function(t){$.each(t,(function(t,e){switch(t){case"rateDownload":case"rateUpload":e=formatSize(e,!0,"speed");break;case"totalSize":case"uploadedEver":case"leftUntilDone":case"completeSize":e=formatSize(e);break;case"addedDate":case"dateCreated":case"doneDate":e=formatLongTime(e);break;case"status":e=system.lang.torrent["status-text"][e];break;case"error":0==e?system.panel.attribute.find("#torrent-attribute-tr-error").hide():system.panel.attribute.find("#torrent-attribute-tr-error").show();break;case"remainingTime":e=e>=31536e8?"":getTotalTime(e);break;case"comment":e=system.replaceURI(e)}system.panel.attribute.find("#torrent-attribute-value-"+t).html(e)}));for(var e=(new Base64).decode_bytes(t.pieces),s=0,n=t.pieceCount,o=t.pieceSize,a=[];s<n;)for(var r=e.codePointAt(s>>3),i=128;i>0&&s<n;i>>=1,++s)a.push(!(r&i));var l=parseInt((499+n)/500),d=formatSize(o*l),c=parseInt((l-1+n)/l),u=0,h="";for(u=0,s=0;u<c;++u){for(var m=l,f=0;f<l;++f,++s)a[s]&&--m;var p=parseInt(100*m/l),g=p/100;h+='<i style="filter:saturate('+parseInt(100*(Math.pow(128,g)-1)/127)/100+')" title="'+d+" x "+p+'%"></i>'}system.panel.attribute.find("#torrent-attribute-pieces").html(h)},fillTorrentFileList:function(t){var e=t.files,s=t.fileStats,n=new Array,o=t.name.length+1;for(var a in e){var r=e[a],i=s[a],l=parseFloat(i.bytesCompleted/r.length*100).toFixed(2);n.push({name:r.name==t.name?r.name:r.name.substr(o),index:a,bytesCompleted:i.bytesCompleted,percentDone:system.getTorrentProgressBar(l,transmission._status.download),length:r.length,wanted:system.lang.torrent.attribute.status[i.wanted],priority:'<span class="iconlabel icon-flag-'+i.priority+'">'+system.lang.torrent.attribute.priority[i.priority]+"</span>"})}this.updateCurrentPageDatas("index",n,system.panel.attribute.find("#torrent-files-table"))},fillTorrentServerList:function(t){var e=t.trackerStats,s=new Array;for(var n in e){var o=e[n],a={};for(var r in o)switch(r){case"lastAnnounceTime":case"nextAnnounceTime":a[r]=formatLongTime(o[r]);break;case"lastAnnounceSucceeded":case"lastAnnounceTimedOut":a[r]=system.lang.torrent.attribute.status[o[r]];break;default:a[r]=o[r]}s.push(a)}transmission.torrents.addTracker(t),this.updateCurrentPageDatas("id",s,system.panel.attribute.find("#torrent-servers-table"))},fillTorrentPeersList:function(t){var e=t.peers,s=new Array;for(var n in e){var o=e[n],a={};for(var r in o)a[r]=o[r];var i=parseFloat(100*o.progress).toFixed(2);a.progress=system.getTorrentProgressBar(i,transmission._status.download),s.push(a)}this.updateCurrentPageDatas("address",s,system.panel.attribute.find("#torrent-peers-table"))},fillTorrentConfig:function(t){4==system.panel.attribute.find("#torrent-attribute-tabs").data("selectedIndex")&&transmission.torrents.getConfig(t.id,(function(t){if(null!=t){var e=transmission.torrents.all[system.currentTorrentId];jQuery.extend(e,t[0]),0!=system.currentTorrentId&&$.each(t[0],(function(t,e){var s=!1,n=!1,o=!1;switch(t){case"seedIdleMode":case"seedRatioMode":0==e&&(n=!1,s=!0),o=!0;case"downloadLimited":case"uploadLimited":1!=e&&1!=e||(n=!0),system.panel.attribute.find("input[enabledof='"+t+"']").prop("disabled",!n),o&&system.panel.attribute.find("#"+t).prop("indeterminate",s).data("_tag",e),system.panel.attribute.find("#"+t).prop("checked",n);break;default:system.panel.attribute.find("#"+t).val(e),system.panel.attribute.find("#"+t).numberspinner("setValue",e)}}))}}))},setFieldFormat:function(t){if(t.formatter)switch(t.formatter){case"size":t.formatter=function(t,e,s){return formatSize(t)};break;case"speed":t.formatter=function(t,e,s){return formatSize(t,!0,"speed")};break;case"longtime":t.formatter=function(t,e,s){return formatLongTime(t)};break;case"progress":t.formatter=function(t,e,s){var n=parseFloat(100*t).toFixed(2);return system.getTorrentProgressBar(n,transmission.torrents.all[e.id])};break;case"_usename_":switch(t.field){case"name":t.formatter=function(t,e,s){return system.getTorrentNameBar(transmission.torrents.all[e.id])}}break;case"ratio":t.formatter=function(t,e,s){var n="";return parseFloat(t)<1&&-1!=t&&(n="text-status-warning"),'<span class="'+n+'">'+(-1==t?"":t)+"</span>"};break;case"remainingTime":t.formatter=function(t,e,s){return t>=31536e8?"":getTotalTime(t)};break;case"labels":t.formatter=function(t,e,s){return system.formetTorrentLabels(t,e.hashString)};break;case"color":t.formatter=function(t,e,s){return $("<span class='user-label'/>").html(t).css({"background-color":t,color:getGrayLevel(t)>.5?"#000":"#fff"}).get(0).outerHTML}}},reloadData:function(){this.popoverCount>0?setTimeout((function(){system.reloadData()}),2e3):(this.reloadSession(),this.reloading=!1,this.getServerStatus(),this.reloading=!1,this.reloadTorrentBaseInfos())},loadFolderList:function(t){for(var e in this.removeTreeNode("folders-loading"),t){var s=t[e];s&&system.removeTreeNode(s.nodeid)}0!=transmission.downloadDirs.length&&timedChunk(transmission.downloadDirs,this.appendFolder,this,10,(function(){"Firefox"==$.ua.browser.name&&$.ua.browser.major<60&&system.panel.left.find("span.nav-total-size").css({"margin-top":"-19px"}),system.initUIStatus()}))},appendFolder:function(t){if(t){var e="folders",s=t.replace(/\\/g,"/").split("/"),n="folders-",o="";for(var a in s){var r=s[a];if(""!=r){o+=r,n+=this.B64.encode(r).replace(/[+|\/|=]/g,"0");var i=this.panel.left.tree("find",n),l=transmission.torrents.folders[n];if(l){var d=r+this.showNodeMoreInfos(l.count,l.size);i?this.updateTreeNodeText(n,d):(this.appendTreeNode(e,[{id:n,path:o,text:d,iconCls:"iconfont tr-icon-file"}]),"folders"!=e&&(i=this.panel.left.tree("find",e),this.panel.left.tree("collapse",i.target))),e=n}else this.debug("appendFolder:key",n),this.debug("appendFolder:name",r),this.debug("appendFolder:node",i)}}}},replaceURI:function(t){return t.replace(/(http|https|ftp):\/\/([^/:]+)(:\d*)?([^# ]*)/gi,(function(t){return'<a href="'+t+'" target="_blank">'+t+"</a>"}))},readConfig:function(){this.readUserConfig();var t=this.getStorageData(this.configHead+".system");for(var e in t&&(this.config=$.extend(!0,this.config,JSON.parse(t))),this.storageKeys.dictionary)this.dictionary[e]=this.getStorageData(this.storageKeys.dictionary[e])},saveConfig:function(){for(var t in this.setStorageData(this.configHead+".system",JSON.stringify(this.config)),this.storageKeys.dictionary)this.setStorageData(this.storageKeys.dictionary[t],this.dictionary[t]);this.saveUserConfig()},saveLabelsConfig:function(t,e){system.config.nav.labels&&(0==e.length?delete system.config.labelMaps[t]:system.config.labelMaps[t]=e)},readUserConfig:function(){var t=window.localStorage[this.configHead];if(t){var e=JSON.parse(t);this.userConfig=$.extend(!0,this.userConfig,e)}},saveUserConfig:function(){window.localStorage[this.configHead]=JSON.stringify(this.userConfig)},uploadTorrentFile:function(t,e,s,n){if(window.FileReader){var o=$("input[id='"+t+"']")[0].files;$.each(o,(function(t,a){transmission.addTorrentFromFile(a,e,s,n,o.length)}))}else alert(system.lang.public["text-browsers-not-support-features"])},checkUpdate:function(){$.ajax({url:this.checkUpdateScript,dataType:"json",success:function(t){if(t&&t.tag_name){var e=t.created_at.substr(0,10).replace(/-/g,""),s=t.tag_name;if(-1!=$.inArray(s,system.config.ignoreVersion))return;if(system.codeupdate<e){$("#area-update-infos").show(),$("#msg-updateInfos").html(e+" -> "+t.name);var n=$("<div/>"),o=t.body.replace(/\r\n/g,"<br/>"),a=$("<div style='text-align:right;'/>").appendTo(n);$('<a href="https://github.com/ronggang/transmission-web-control/releases/latest" target="_blank" class="easyui-linkbutton" data-options="iconCls:\'iconfont tr-icon-github\'"/>').html(t.name+" ("+e+")").appendTo(a).linkbutton(),$("<span/>").html(" ").appendTo(a),$('<a href="https://github.com/ronggang/transmission-web-control/wiki" target="_blank" class="easyui-linkbutton" data-options="iconCls:\'iconfont tr-icon-help\'"/>').html(system.lang.public["text-how-to-update"]).appendTo(a).linkbutton(),$("<span/>").html(" ").appendTo(a),$("<button onclick=\"javascript:system.addIgnoreVersion('"+s+'\');" class="easyui-linkbutton" data-options="iconCls:\'iconfont tr-icon-cancel-checked\'"/>').html(system.lang.public["text-ignore-this-version"]).appendTo(a).linkbutton(),$("<hr/>").appendTo(n),$("<div/>").html(o).appendTo(n),$("#button-download-update").webuiPopover({content:n.html(),backdrop:!0})}else $("#area-update-infos").hide()}}})},addIgnoreVersion:function(t){-1==$.inArray(t,system.config.ignoreVersion)&&(this.config.ignoreVersion.push(t),this.saveConfig()),$("#button-download-update").webuiPopover("hide"),$("#area-update-infos").hide()},changeLanguages:function(t){t!=this.lang.name&&t&&(this.config.defaultLang=t,this.saveConfig(),location.href="?lang="+t)},getStorageData:function(t,e){return null==window.localStorage[t]?e:window.localStorage[t]},setStorageData:function(t,e){window.localStorage[t]=e},openDialogFromTemplate:function(t){if(null!=(t=$.extend(!0,{id:null,options:null,datas:null,type:0},t)).id){var e=t.id,s=t.options,n=t.datas,o=$("#"+e);if(o.length){if(n&&$.each(n,(function(t,e){o.data(t,e)})),0==t.type&&o.attr("type")==t.type)return o.dialog("open"),void o.dialog({content:system.templates[e]});if(0!=system.popoverCount)return void setTimeout((function(){system.openDialogFromTemplate(t)}),350);o.remove()}var a={title:"",width:100,height:100,resizable:!1,cache:!0,content:system.lang.dialog["system-config"].loading,modal:!0};s=$.extend(!0,a,s),o=$("<div/>").attr({id:e,type:t.type}).appendTo(document.body),0==t.type?o.dialog(s):(o.css({width:s.width,height:s.height}).data("popoverSource",t.source),$(t.source).webuiPopover({url:"#"+e,title:s.title,width:s.width,height:s.height-18,padding:!1,onHide:function(s){$(t.source).webuiPopover("destroy"),$("#"+e).remove(),$(s).remove(),system.popoverCount--,t.onClose&&t.onClose(t.source)},onShow:function(){system.popoverCount++}})),$.get(system.rootPath+"template/"+e+".html?time="+new Date,(function(s){system.templates[e]=s,n&&$.each(n,(function(t,s){$("#"+e).data(t,s)})),0==t.type?$("#"+e).dialog({content:s}):(o.html(s),$.parser.parse("#"+e),$(t.source).webuiPopover("show"))}))}},debug:function(t,e){window.console&&window.console.log&&window.console.log(t,e)},initThemes:function(){this.themes&&$("#select-themes").combobox({groupField:"group",data:this.themes,editable:!1,panelHeight:"auto",onChange:function(t){var e=(t+";").split(";"),s=e[0],n=e[1]||"logo.png";$("#styleEasyui").attr("href","tr-web-control/script/easyui/themes/"+s+"/easyui.css"),$("#logo").attr("src","tr-web-control/"+n),system.config.theme=t,system.saveConfig()},onLoadSuccess:function(){$(this).combobox("setValue",system.config.theme||"default")}})},getValidTreeKey:function(t){return t?this.B64.encode(t).replace(/[+|\/|=]/g,"0"):""}};function pagerFilter(t){"number"==typeof t.length&&"function"==typeof t.splice&&(t={total:t.length,rows:t});var e=$(this),s=e.datagrid("options"),n=e.datagrid("getPager"),o=e.data("buttons");n.pagination({onSelectPage:function(o,a){s.pageNumber=o,s.pageSize=a,n.pagination("refresh",{pageNumber:o,pageSize:a}),e.datagrid("loadData",t)},buttons:o}),t.originalRows||(t.originalRows=t.rows);var a=(s.pageNumber-1)*parseInt(s.pageSize),r=a+parseInt(s.pageSize);if(t.rows=t.originalRows.slice(a,r),o&&o.length)for(var i=0;i<o.length;i++){var l=o[i];l.id&&l.title&&$("#"+l.id,n).attr("title",l.title)}return t}$(document).ready((function(){$.getJSON(system.rootPath+"i18n/en.json").done((function(t){system.defaultLang=t})),$.getJSON(system.rootPath+"i18n.json").done((function(t){system.languages=t,system.init(location.search.getQueryString("lang"),location.search.getQueryString("local"))}))}));
diff --git a/src/tr-web-control/script/system.js b/src/tr-web-control/script/system.js
index 8af1a8e..4430e3d 100644
--- a/src/tr-web-control/script/system.js
+++ b/src/tr-web-control/script/system.js
@@ -2576,7 +2576,7 @@ var system = {
 			//this.panel.attribute.panel({iconCls:"icon-loading"});
 			var torrent = transmission.torrents.all[id];
 			torrent.infoIsLoading = true;
-			var fields = "fileStats,trackerStats,peers,leftUntilDone,status,rateDownload,rateUpload,uploadedEver,uploadRatio,error,errorString";
+			var fields = "fileStats,trackerStats,peers,leftUntilDone,status,rateDownload,rateUpload,uploadedEver,uploadRatio,error,errorString,pieces,pieceCount,pieceSize";
 			// If this is the first time to load this torrent information, load more information
 			if (!torrent.moreInfosTag) {
 				fields += ",files,trackers,comment,dateCreated,creator,downloadDir";
@@ -2721,6 +2721,35 @@ var system = {
 			}
 			system.panel.attribute.find("#torrent-attribute-value-" + key).html(value);
 		});
+		var pieces = new Base64().decode_bytes(torrent.pieces);
+		var piece = 0;
+		var pieceCount = torrent.pieceCount;
+		var pieceSize = torrent.pieceSize;
+		var piecesFlag = []; //inverted
+		while(piece < pieceCount) {
+			var bset = pieces.codePointAt(piece >> 3);
+			for (var test=0x80; test > 0 && piece < pieceCount; test=test>>1, ++piece) {
+				piecesFlag.push((bset & test)?false:true);
+			}
+		}
+		var MAXCELLS = 500;
+		
+		var piecePerCell = parseInt((MAXCELLS-1+pieceCount)/MAXCELLS);
+		var cellSize = formatSize(pieceSize * piecePerCell);
+		var cellCount = parseInt((piecePerCell-1+pieceCount)/piecePerCell);
+		var cell = 0;
+		var cells = '';
+		for (var cell = 0, piece = 0; cell < cellCount; ++ cell) {
+			var done = piecePerCell;
+			for (var i=0; i<piecePerCell; ++i,++piece) {
+				if (piecesFlag[piece]) --done;
+			}
+			var percent = parseInt(done*100/piecePerCell);
+			var rate = percent/100;
+			var ramp = parseInt((Math.pow(128, rate)-1)*100/127)/100;
+			cells += ('<i style="filter:saturate(' + ramp + ')" title="'+cellSize+' x '+percent+'%"></i>');
+		}
+		system.panel.attribute.find("#torrent-attribute-pieces").html(cells);
 	},
 	// Fill the torrent with a list of files
 	fillTorrentFileList: function (torrent) {
diff --git a/src/tr-web-control/style/base.css b/src/tr-web-control/style/base.css
index 5ce5570..93ee565 100644
--- a/src/tr-web-control/style/base.css
+++ b/src/tr-web-control/style/base.css
@@ -356,4 +356,17 @@ html, body {
 
 .combobox-item {
 	cursor: pointer;
-}
\ No newline at end of file
+}
+
+#torrent-attribute-pieces {
+	line-height: 10px;
+}
+
+#torrent-attribute-pieces>i {
+	background-color: mediumseagreen;
+	border: 1px solid white;
+	display: inline-block !important;
+    height: 10px !important;
+    width: 10px !important;
+	margin: 1px;
+}
diff --git a/src/tr-web-control/template/torrent-attribute.html b/src/tr-web-control/template/torrent-attribute.html
index 987ddeb..def444f 100644
--- a/src/tr-web-control/template/torrent-attribute.html
+++ b/src/tr-web-control/template/torrent-attribute.html
@@ -65,6 +65,15 @@
 						<td class="title"><span id="torrent-attribute-label-comment"></span></td>
 						<td colspan="3"><span id="torrent-attribute-value-comment"></span></td>
 					</tr>
+					<tr>
+						<td colspan="4">
+							<hr/>
+							<div id="torrent-attribute-pieces">
+								<i style="filter:saturate(0)" title="100MB x 0%"></i><i  style="filter:saturate(0.5)" title="100MB x 50%"></i><br/>
+								<i style="filter:saturate(1)" title="100MB x 100%"></i>
+							</div>
+						</td>
+					</tr>
 				</table>
 			</div>
 			<div title="" style="padding:0px;" id="torrent-attribute-servers">
-- 
2.23.0

